<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MERIDA - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .admin-nav-item.active { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="admin-auth-container" class="min-h-screen bg-gray-800 flex items-center justify-center p-4">
        <div class="w-full max-w-sm bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-bold text-center text-slate-800 mb-6">Admin Login</h2>
            <div id="admin-error-message" class="mb-4 text-center text-red-500 font-medium h-5"></div>
            <form id="admin-login-form">
                <div class="mb-4">
                    <label for="admin-login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="admin-login-email" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="admin-login-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="admin-login-password" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">Login</button>
            </form>
        </div>
    </div>

    <div id="admin-app-container" class="hidden">
        <header class="bg-slate-800 text-white p-4 flex justify-between items-center">
            <h1 class="text-xl font-bold">MERIDA Admin</h1>
            <button id="admin-logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Logout</button>
        </header>

        <div class="flex">
            <nav class="w-48 bg-slate-700 min-h-screen p-4">
                <ul>
                    <li><button data-page="dashboard" class="admin-nav-item w-full text-left font-semibold py-2 px-3 rounded-lg mb-2 text-slate-200 hover:bg-slate-600 active">Dashboard</button></li>
                    <li><button data-page="users" class="admin-nav-item w-full text-left font-semibold py-2 px-3 rounded-lg mb-2 text-slate-200 hover:bg-slate-600">Users</button></li>
                    <li><button data-page="deposits" class="admin-nav-item w-full text-left font-semibold py-2 px-3 rounded-lg mb-2 text-slate-200 hover:bg-slate-600">Deposit Requests</button></li>
                    <li><button data-page="withdrawals" class="admin-nav-item w-full text-left font-semibold py-2 px-3 rounded-lg mb-2 text-slate-200 hover:bg-slate-600">Withdrawal Requests</button></li>
                </ul>
            </nav>
            <main class="flex-grow p-6">
                <div id="admin-page-dashboard">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-slate-600">Total Users</p><p id="total-users-stat" class="text-3xl font-bold">0</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-slate-600">Pending Deposits</p><p id="pending-deposits-stat" class="text-3xl font-bold">0</p></div>
                        <div class="bg-white p-4 rounded-lg shadow"><p class="text-slate-600">Pending Withdrawals</p><p id="pending-withdrawals-stat" class="text-3xl font-bold">0</p></div>
                    </div>
                </div>

                <div id="admin-page-users" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">All Users</h2>
                    <div id="all-users-list" class="bg-white p-4 rounded-lg shadow"></div>
                </div>

                <div id="admin-page-deposits" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Deposit Requests</h2>
                    <div id="deposit-requests-list" class="bg-white p-4 rounded-lg shadow"></div>
                </div>

                <div id="admin-page-withdrawals" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-4">Withdrawal Requests</h2>
                    <div id="withdrawal-requests-list" class="bg-white p-4 rounded-lg shadow"></div>
                </div>
            </main>
        </div>
    </div>
     <div id="message-modal" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl z-50 animate-pulse"><p id="message-modal-text"></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, getDocs, query, where, increment, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener("DOMContentLoaded", () => {
            const firebaseConfig = {
                apiKey: "AIzaSyB8Ni8HRr5lbtvD3WDcly9xTAdAl2OKNNQ",
                authDomain: "merida-47818.firebaseapp.com",
                projectId: "merida-47818",
                storageBucket: "merida-47818.appspot.com",
                messagingSenderId: "606896191722",
                appId: "1:606896191722:web:bf309888bd1cfbb6123f93",
                measurementId: "G-SPSG3DYMY7"
            };
            const ADMIN_EMAIL = 'cleophasamutete@gmail.com';
            let app, auth, db;
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) { console.error("Firebase init failed:", e); return; }

            const DOMElements = {
                authContainer: document.getElementById('admin-auth-container'),
                appContainer: document.getElementById('admin-app-container'),
                errorMessage: document.getElementById('admin-error-message'),
                loginForm: document.getElementById('admin-login-form'),
                logoutBtn: document.getElementById('admin-logout-btn'),
                navItems: document.querySelectorAll('.admin-nav-item'),
                pages: {
                    dashboard: document.getElementById('admin-page-dashboard'),
                    users: document.getElementById('admin-page-users'),
                    deposits: document.getElementById('admin-page-deposits'),
                    withdrawals: document.getElementById('admin-page-withdrawals'),
                },
                allUsersList: document.getElementById('all-users-list'),
                depositRequestsList: document.getElementById('deposit-requests-list'),
                withdrawalRequestsList: document.getElementById('withdrawal-requests-list'),
                totalUsersStat: document.getElementById('total-users-stat'),
                pendingDepositsStat: document.getElementById('pending-deposits-stat'),
                pendingWithdrawalsStat: document.getElementById('pending-withdrawals-stat'),
                 messageModal: document.getElementById('message-modal'),
                messageModalText: document.getElementById('message-modal-text'),
            };
            const showMessage = (text, isError = false) => { DOMElements.messageModalText.textContent = text; DOMElements.messageModal.classList.toggle('bg-red-500', isError); DOMElements.messageModal.classList.toggle('bg-green-500', !isError); DOMElements.messageModal.classList.remove('hidden'); setTimeout(() => DOMElements.messageModal.classList.add('hidden'), 3500); };
            const switchPage = (pageName) => {
                Object.values(DOMElements.pages).forEach(p => p.classList.add('hidden'));
                if (DOMElements.pages[pageName]) DOMElements.pages[pageName].classList.remove('hidden');
                DOMElements.navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageName));
            };

            const renderAllUsers = (users) => {
                DOMElements.allUsersList.innerHTML = `
                    <table class="min-w-full text-sm text-left">
                        <thead class="bg-slate-100"><tr>
                            <th class="p-2">Username</th><th>Email</th><th>Level</th><th>Balance</th><th>Actions</th>
                        </tr></thead>
                        <tbody>${users.map(u => `
                            <tr class="border-b">
                                <td class="p-2 font-semibold">${u.username}</td><td>${u.email}</td>
                                <td><input data-uid="${u.uid}" class="level-input w-24 p-1 border rounded" type="text" value="${u.investmentLevel}"></td>
                                <td>Ksh ${u.totalAssets.toFixed(2)}</td>
                                <td>
                                    <button data-uid="${u.uid}" class="update-level-btn bg-blue-500 text-white px-2 py-1 text-xs rounded hover:bg-blue-600">Save</button>
                                    <button data-uid="${u.uid}" data-username="${u.username}" class="delete-user-btn bg-red-500 text-white px-2 py-1 text-xs rounded hover:bg-red-600 ml-1">Delete</button>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>`;
                 DOMElements.totalUsersStat.textContent = users.length;
            };

            const renderRequests = (requests, listElement, type) => {
                 listElement.innerHTML = requests.length === 0 ? '<p class="text-slate-500">No pending requests.</p>' : `
                    <div class="space-y-3">${requests.map(r => `
                        <div class="bg-slate-50 p-3 rounded-lg flex justify-between items-center">
                            <div>
                                <p class="font-semibold">${r.username} (${r.userId})</p>
                                <p class="text-sm text-slate-600">${type === 'withdrawal' ? `requests a withdrawal of <span class="font-bold">Ksh ${r.amount.toFixed(2)}</span>` : 'has notified of a deposit.'}</p>
                                <p class="text-xs text-slate-400">${r.timestamp.toDate().toLocaleString()}</p>
                            </div>
                            <div>
                                <button data-id="${r.id}" data-uid="${r.userId}" ${type === 'withdrawal' || type === 'deposit' ? `data-amount="${r.amount}"` : ''} class="approve-btn bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Approve</button>
                                <button data-id="${r.id}" data-uid="${r.userId}" ${type === 'withdrawal' ? `data-amount="${r.amount}"` : ''} class="reject-btn bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 ml-2">Reject</button>
                            </div>
                        </div>`).join('')}
                    </div>`;
            };

            const handleRequest = async (e, action) => {
                const { id, uid, amount } = e.target.dataset;
                const isApproval = action === 'approve';
                const type = e.target.closest('#deposit-requests-list') ? 'deposit' : 'withdrawal';

                if (!confirm(`Are you sure you want to ${action} this ${type} request?`)) return;

                try {
                    if (isApproval && type === 'withdrawal') {
                        // Withdrawal approved, money already deducted on user side. Just delete notification.
                         await deleteDoc(doc(db, "admin_notifications", id));
                         showMessage('Withdrawal approved and removed.');
                    } else if (!isApproval && type === 'withdrawal') {
                        // Withdrawal rejected, refund the user.
                        const userRef = doc(db, "users", uid);
                        await updateDoc(userRef, { totalAssets: increment(parseFloat(amount)) });
                        await deleteDoc(doc(db, "admin_notifications", id));
                        showMessage('Withdrawal rejected and funds returned.');
                    } else if (isApproval && type === 'deposit') {
                        // Deposit approved. The admin should have verified the deposit.
                        // Here we just delete the notification. The admin must manually update the user's level.
                        await deleteDoc(doc(db, "admin_notifications", id));
                        showMessage('Deposit approved. Remember to set user level.');
                    } else if (!isApproval && type === 'deposit') {
                        // Deposit rejected. Just delete the notification.
                        await deleteDoc(doc(db, "admin_notifications", id));
                        showMessage('Deposit request rejected.');
                    }
                } catch(err) {
                    console.error("Error handling request:", err);
                    showMessage('Operation failed.', true);
                }
            };
            
            const deleteUser = async (e) => {
                const { uid, username } = e.target.dataset;
                if (!confirm(`Are you sure you want to PERMANENTLY DELETE user "${username}"? This action cannot be undone.`)) return;
                
                try {
                    // This is a "soft" delete from the admin panel's perspective.
                    // We delete the user document in Firestore.
                    // The actual user account in Firebase Auth would need to be deleted via a backend function for security reasons.
                    await deleteDoc(doc(db, "users", uid));
                    showMessage(`User ${username} deleted successfully.`);
                } catch (err) {
                    console.error("Error deleting user:", err);
                    showMessage(`Failed to delete user ${username}.`, true)
                }
            };


            DOMElements.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                DOMElements.errorMessage.textContent = '';
                try {
                    const email = DOMElements.loginForm['admin-login-email'].value;
                    const pass = DOMElements.loginForm['admin-login-password'].value;
                    if (email.toLowerCase() !== ADMIN_EMAIL) {
                        DOMElements.errorMessage.textContent = 'Access denied.';
                        return;
                    }
                    await signInWithEmailAndPassword(auth, email, pass);
                } catch (error) {
                    DOMElements.errorMessage.textContent = error.message.replace('Firebase: ', '');
                }
            });

            DOMElements.logoutBtn.addEventListener('click', () => signOut(auth));
            DOMElements.navItems.forEach(item => item.addEventListener('click', () => switchPage(item.dataset.page)));

            DOMElements.allUsersList.addEventListener('click', (e) => {
                if(e.target.classList.contains('update-level-btn')) {
                    const uid = e.target.dataset.uid;
                    const newLevel = e.target.closest('tr').querySelector('.level-input').value;
                    updateDoc(doc(db, "users", uid), { investmentLevel: newLevel })
                        .then(() => showMessage('User level updated.'))
                        .catch(err => showMessage('Update failed.', true));
                }
                 if(e.target.classList.contains('delete-user-btn')) {
                    deleteUser(e);
                }
            });

            DOMElements.depositRequestsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('approve-btn')) handleRequest(e, 'approve');
                if (e.target.classList.contains('reject-btn')) handleRequest(e, 'reject');
            });
            DOMElements.withdrawalRequestsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('approve-btn')) handleRequest(e, 'approve');
                if (e.target.classList.contains('reject-btn')) handleRequest(e, 'reject');
            });


            onAuthStateChanged(auth, user => {
                if (user && user.email.toLowerCase() === ADMIN_EMAIL) {
                    DOMElements.authContainer.style.display = 'none';
                    DOMElements.appContainer.style.display = 'block';
                    switchPage('dashboard');

                    onSnapshot(collection(db, "users"), (snapshot) => renderAllUsers(snapshot.docs.map(d => ({...d.data(), uid: d.id}))));
                    
                    const depositQuery = query(collection(db, "admin_notifications"), where("type", "==", "deposit_notification"));
                    onSnapshot(depositQuery, (snapshot) => {
                        const requests = snapshot.docs.map(d => ({...d.data(), id: d.id}));
                        renderRequests(requests, DOMElements.depositRequestsList, 'deposit');
                        DOMElements.pendingDepositsStat.textContent = requests.length;
                    });
                    
                    const withdrawalQuery = query(collection(db, "admin_notifications"), where("type", "==", "withdrawal_request"));
                    onSnapshot(withdrawalQuery, (snapshot) => {
                        const requests = snapshot.docs.map(d => ({...d.data(), id: d.id}));
                        renderRequests(requests, DOMElements.withdrawalRequestsList, 'withdrawal');
                        DOMElements.pendingWithdrawalsStat.textContent = requests.length;
                    });

                } else {
                    DOMElements.authContainer.style.display = 'flex';
                    DOMElements.appContainer.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
