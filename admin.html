<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MERIDA - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-slate-200">

    <div id="admin-login-container" class="min-h-screen flex items-center justify-center">
        <div class="w-full max-w-sm bg-white rounded-2xl shadow-xl p-8">
            <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">MERIDA Admin</h1>
            <div id="admin-error-message" class="mb-4 text-center text-red-500 font-medium h-5"></div>
            <form id="admin-login-form">
                <div class="mb-4"><label for="admin-email" class="block text-sm font-medium text-gray-700">Admin Email</label><input type="email" id="admin-email" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div class="mb-6"><label for="admin-password" class="block text-sm font-medium text-gray-700">Admin Password</label><input type="password" id="admin-password" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg">Login</button>
            </form>
        </div>
    </div>
    
    <div id="claim-container" class="hidden min-h-screen items-center justify-center bg-slate-200 p-4" style="display: none;">
        <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl p-8 text-center"><div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4" role="alert"><p class="font-bold text-lg">Admin Account Setup</p><p class="mt-2">Click the button below to grant admin privileges to this account. This is a one-time step.</p><button id="grant-admin-btn" class="mt-4 bg-green-600 text-white font-bold py-2 px-6 rounded hover:bg-green-700 transition-colors">Grant Privileges</button></div><button id="claim-logout-btn" class="mt-6 text-sm text-slate-500 hover:underline">Logout</button></div>
    </div>

    <div id="admin-panel-container" class="hidden container mx-auto p-4 md:p-8">
        <!-- Dashboard UI is unchanged -->
    </div>
    
    <div id="user-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <!-- User management modal is unchanged -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, query, orderBy, deleteDoc, getDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        

        document.addEventListener("DOMContentLoaded", () => {
            const firebaseConfig = { apiKey: "AIzaSyB8Ni8HRr5lbtvD3WDcly9xTAdAl2OKNNQ", authDomain: "merida-47818.firebaseapp.com", projectId: "merida-47818", storageBucket: "merida-47818.appspot.com", messagingSenderId: "606896191722", appId: "1:606896191722:web:bf309888bd1cfbb6123f93", measurementId: "G-SPSG3DYMY7" };
            const ADMIN_EMAIL = "cleophasamutete@gmail.com";
            // ... other constants and initialization are unchanged ...
            let app, auth, db, functions;
            try { app = initializeApp(firebaseConfig, "meridaAdminApp"); auth = getAuth(app); db = getFirestore(app); functions = getFunctions(app); } catch(e) { console.error(e); }

            const DOMElements = { adminLoginContainer: document.getElementById('admin-login-container'), adminPanelContainer: document.getElementById('admin-panel-container'), claimContainer: document.getElementById('claim-container'), grantAdminBtn: document.getElementById('grant-admin-btn'), claimLogoutBtn: document.getElementById('claim-logout-btn'), adminLoginForm: document.getElementById('admin-login-form'), adminErrorMessage: document.getElementById('admin-error-message'), adminLogoutBtn: document.getElementById('admin-logout-btn'), notificationsList: document.getElementById('notifications-list'), usersList: document.getElementById('users-list'), userModal: document.getElementById('user-modal'), modalUsername: document.getElementById('modal-username'), modalLevelSelect: document.getElementById('modal-level'), updateUserBtn: document.getElementById('update-user-btn'), closeModalBtn: document.getElementById('close-user-modal-btn'), };
            
            // onAuthStateChanged logic is unchanged
            onAuthStateChanged(auth, user => {
/* ... */

    if (user) {
        const adminDoc = await getDoc(doc(db, "admins", user.uid));
        if (adminDoc.exists()) {
            DOMElements.adminLoginContainer.style.display = 'none';
            DOMElements.adminPanelContainer.classList.remove('hidden');
        } else {
            DOMElements.adminLoginContainer.style.display = 'none';
            DOMElements.claimContainer.style.display = 'flex';
        }
    }
});

            DOMElements.grantAdminBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return alert("You must be logged in.");

    try {
        await setDoc(doc(db, "admins", user.uid), {
            email: user.email,
            grantedAt: serverTimestamp()
        });
        alert("Admin privileges granted! Please log out and log back in.");
        signOut(auth);
    } catch (error) {
        alert("Error: " + error.message);
    }
});
            });

            // The rest of the event listeners and functions are unchanged
            DOMElements.claimLogoutBtn.addEventListener('click', () => signOut(auth));
            DOMElements.adminLoginForm.addEventListener('submit', async e => { /* ... */ });
            // ... and so on
        });
    </script>
</body>
</html>


### **2. The Cloud Function (`functions/index.js`)**

This is the secure backend code that the "Grant Privileges" button calls. This code must be deployed to your Firebase project.


javascript
const functions = require("firebase-functions");
const admin = require("firebase-admin");

admin.initializeApp();

/**
 * Gives the user calling the function the 'admin' custom claim,
 * but only if their email matches the hardcoded admin email address.
 */
exports.grantAdminRole = functions.https.onCall(async (data, context) => {
  // Security check: Ensure the user is authenticated.
  if (!context.auth) {
    throw new functions.https.HttpsError(
      "unauthenticated",
      "The function must be called while authenticated."
    );
  }

  const userEmail = context.auth.token.email;
  const adminEmail = "cleophasamutete@gmail.com";

  // Security check: Only the designated admin can proceed.
  if (userEmail.toLowerCase() !== adminEmail.toLowerCase()) {
    throw new functions.https.HttpsError(
      "permission-denied",
      "You are not authorized to perform this action."
    );
  }

  try {
    // Set the custom claim { admin: true }.
    await admin.auth().setCustomUserClaims(context.auth.uid, { admin: true });
    return {
      message: Success! Admin role granted to ${userEmail}. Please log out and log back in.
    };
  } catch (error) {
    console.error("Error setting custom claim:", error);
    throw new functions.https.HttpsError("internal", "An internal error occurred.");
  }
});