<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MERIDA - Investment App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .merida-logo-text { font-weight: 900; letter-spacing: -0.05em; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .nav-item.active { color: #3b82f6; } /* blue-500 */
        .btn-disabled { background-color: #d1d5db; cursor: not-allowed; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="auth-container" style="display: none;" class="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex flex-col items-center justify-center p-4">
        <h1 class="text-7xl font-black text-white merida-logo-text mb-6">MERIDA</h1>
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6">
            <div class="flex border-b border-gray-200">
                <button id="login-tab-btn" class="flex-1 py-3 font-semibold text-lg border-b-4 border-blue-500 text-blue-500">Login</button>
                <button id="signup-tab-btn" class="flex-1 py-3 font-semibold text-lg text-gray-500">Sign Up</button>
            </div>
            <div id="error-message" class="mt-4 text-center text-red-500 font-medium h-5"></div>
            <div class="mt-6">
                <form id="login-form">
                    <div class="mb-4"><label for="login-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-6"><label for="login-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-300 shadow-lg">Login</button>
                </form>
                <form id="signup-form" class="hidden">
                    <div class="mb-4"><label for="signup-username" class="block text-sm font-medium text-gray-700">Username</label><input type="text" id="signup-username" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-4"><label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-4"><label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="signup-password" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-6"><label for="signup-confirm-password" class="block text-sm font-medium text-gray-700">Confirm Password</label><input type="password" id="signup-confirm-password" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-300 shadow-lg">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden w-full max-w-lg mx-auto bg-slate-200 flex-col h-screen">
        <header class="bg-blue-600 text-white p-4 shadow-lg flex justify-between items-center z-10 sticky top-0">
             <div><p class="text-sm opacity-80">Welcome back,</p><h2 id="user-name-display" class="font-bold text-xl">User</h2></div>
              <div class="text-right"><p class="text-sm opacity-80">Available Profit</p><h2 id="total-assets-display" class="font-bold text-xl">Ksh 0.00</h2></div>
        </header>

        <main class="flex-grow p-4 overflow-y-auto pb-24">
            <div id="page-home">
                <div class="grid grid-cols-2 gap-4 text-center mb-6">
                     <div id="deposit-btn" class="bg-white p-4 rounded-xl shadow-md cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-wallet text-blue-500 text-2xl"></i><p class="font-semibold text-sm mt-1 text-slate-700">Deposit</p></div>
                    <div id="withdraw-btn" class="bg-white p-4 rounded-xl shadow-md cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-money-bill-transfer text-blue-500 text-2xl"></i><p class="font-semibold text-sm mt-1 text-slate-700">Withdraw</p></div>
                </div>
            </div>
        </main>

        <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around max-w-lg mx-auto">
             <button data-page="home" class="nav-item flex-1 py-3 text-center text-slate-600 hover:bg-slate-100 transition active"><i class="fas fa-home text-xl"></i><span class="block text-xs font-medium">Home</span></button>
             <button data-page="work" class="nav-item flex-1 py-3 text-center text-slate-600 hover:bg-slate-100 transition"><i class="fas fa-briefcase text-xl"></i><span class="block text-xs font-medium">Work</span></button>
        </footer>
    </div>
    
    <div id="deposit-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <h3 class="font-bold text-xl mb-4 text-center">Deposit Instructions</h3>
            <p class="text-slate-600 mb-2 text-center">Send your investment via M-Pesa to:</p>
            <div class="bg-slate-100 rounded-lg p-3 my-4 text-center">
                <p class="text-slate-800 font-bold text-2xl tracking-widest">0745 875 920</p>
            </div>
            <p class="text-slate-600 text-sm mb-4 text-center">After sending, enter the details below and submit.</p>
            <div class="space-y-4 mb-5">
                <div><label for="deposit-amount-input" class="block text-sm font-medium text-gray-700">Amount Sent (Ksh)</label><input type="number" id="deposit-amount-input" placeholder="e.g., 500" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div><label for="deposit-reference-input" class="block text-sm font-medium text-gray-700">M-Pesa Code</label><input type="text" id="deposit-reference-input" placeholder="e.g., SGE4R..." class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
            </div>
            <button id="submit-deposit-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-300 shadow-lg mb-2">Submit Deposit</button>
            <button id="close-deposit-modal-btn" class="text-slate-500 font-semibold w-full text-center">Close</button>
        </div>
    </div>
    <div id="withdraw-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4"><div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center"><h3 class="font-bold text-xl mb-3">Request Withdrawal</h3><p class="text-slate-600 mb-4">Enter amount to withdraw. Minimum depends on your level.</p><input type="number" id="withdraw-amount" placeholder="Ksh 0.00" class="w-full text-center px-3 py-2 text-lg font-bold bg-slate-50 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><button id="submit-withdrawal-btn" class="mt-4 w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 shadow-lg transition">Submit Request</button><button id="cancel-withdraw-modal-btn" class="mt-3 text-slate-500 font-semibold">Cancel</button></div></div>
    <div id="message-modal" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl z-50 animate-pulse"><p id="message-modal-text"></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, increment, collection, addDoc, query, where, getDocs, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener("DOMContentLoaded", () => {
            const firebaseConfig = {
                apiKey: "AIzaSyB8Ni8HRr5lbtvD3WDcly9xTAdAl2OKNNQ",
                authDomain: "merida-47818.firebaseapp.com",
                projectId: "merida-47818",
                storageBucket: "merida-47818.appspot.com",
                messagingSenderId: "606896191722",
                appId: "1:606896191722:web:bf309888bd1cfbb6123f93",
                measurementId: "G-SPSG3DYMY7"
            };
             const INVESTMENT_LEVELS = {
                'level-1': { minWithdraw: 200 }, 'level-2': { minWithdraw: 500 }, 'level-3': { minWithdraw: 500 },
                'level-4': { minWithdraw: 700 }, 'level-5': { minWithdraw: 1000 }, 'level-6': { minWithdraw: 1500 },
                'None': { minWithdraw: Infinity }
            };

            let app, auth, db, currentUserData = null, unsubscribeUser = null;
            try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error("Firebase init failed:", e); alert("Cannot connect to server."); return; }
            
            const DOMElements = {
                authContainer: document.getElementById('auth-container'), appContainer: document.getElementById('app-container'), errorMessage: document.getElementById('error-message'), loginTabBtn: document.getElementById('login-tab-btn'), signupTabBtn: document.getElementById('signup-tab-btn'), loginForm: document.getElementById('login-form'), signupForm: document.getElementById('signup-form'),
                userNameDisplay: document.getElementById('user-name-display'), totalAssetsDisplay: document.getElementById('total-assets-display'), 
                depositBtn: document.getElementById('deposit-btn'), depositModal: document.getElementById('deposit-modal'), closeDepositModalBtn: document.getElementById('close-deposit-modal-btn'), submitDepositBtn: document.getElementById('submit-deposit-btn'), depositAmountInput: document.getElementById('deposit-amount-input'), depositReferenceInput: document.getElementById('deposit-reference-input'),
                withdrawBtn: document.getElementById('withdraw-btn'), withdrawModal: document.getElementById('withdraw-modal'), cancelWithdrawModalBtn: document.getElementById('cancel-withdraw-modal-btn'), submitWithdrawalBtn: document.getElementById('submit-withdrawal-btn'), withdrawAmountInput: document.getElementById('withdraw-amount'),
                messageModal: document.getElementById('message-modal'), messageModalText: document.getElementById('message-modal-text'),
            };

            const showMessage = (text, isError = false) => { DOMElements.messageModalText.textContent = text; DOMElements.messageModal.classList.toggle('bg-red-500', isError); DOMElements.messageModal.classList.toggle('bg-green-500', !isError); DOMElements.messageModal.classList.remove('hidden'); setTimeout(() => DOMElements.messageModal.classList.add('hidden'), 3500); };
            const switchAuthTab = (tab) => { /* ... (UI logic) ... */ };
            const listenToUserData = (user) => { if (unsubscribeUser) unsubscribeUser(); const userRef = doc(db, "users", user.uid); unsubscribeUser = onSnapshot(userRef, (docSnap) => { if (docSnap.exists()) { currentUserData = { id: docSnap.id, ...docSnap.data() }; updateUI(currentUserData); }}); };
            const updateUI = (data) => { if (!data) return; DOMElements.userNameDisplay.textContent = data.username; DOMElements.totalAssetsDisplay.textContent = `Ksh ${parseFloat(data.totalAssets || 0).toFixed(2)}`; };
            
            // --- Event Listeners ---
            DOMElements.loginTabBtn.addEventListener('click', () => switchAuthTab('login'));
            DOMElements.signupTabBtn.addEventListener('click', () => switchAuthTab('signup'));
            DOMElements.loginForm.addEventListener('submit', async (e) => { e.preventDefault(); try { await signInWithEmailAndPassword(auth, DOMElements.loginForm['login-email'].value, DOMElements.loginForm['login-password'].value); } catch (e) { DOMElements.errorMessage.textContent = e.message; } });
            DOMElements.signupForm.addEventListener('submit', async (e) => { /* ... (Signup logic) ... */ });

            // --- [UPDATED] Deposit Modal Logic ---
            DOMElements.depositBtn.addEventListener('click', () => DOMElements.depositModal.classList.remove('hidden'));
            DOMElements.closeDepositModalBtn.addEventListener('click', () => DOMElements.depositModal.classList.add('hidden'));
            DOMElements.submitDepositBtn.addEventListener('click', async () => {
                const amount = parseFloat(DOMElements.depositAmountInput.value);
                const reference = DOMElements.depositReferenceInput.value.trim();

                if (isNaN(amount) || amount <= 0 || !reference) {
                    showMessage('Please enter a valid amount and M-Pesa code.', true);
                    return;
                }

                try {
                    await addDoc(collection(db, 'deposits'), {
                        userId: auth.currentUser.uid,
                        username: currentUserData.username,
                        amount: amount,
                        reference: reference,
                        method: 'M-Pesa',
                        status: 'pending', // This is critical for the admin panel
                        timestamp: serverTimestamp()
                    });
                    showMessage('Deposit request submitted for review!');
                    DOMElements.depositAmountInput.value = '';
                    DOMElements.depositReferenceInput.value = '';
                    DOMElements.depositModal.classList.add('hidden');
                } catch (e) {
                    showMessage('Request failed. Please try again.', true);
                    console.error("Deposit error:", e);
                }
            });

            // --- [UPDATED] Withdraw Modal Logic ---
            DOMElements.withdrawBtn.addEventListener('click', () => { 
                if (!currentUserData) return;
                const levelInfo = INVESTMENT_LEVELS[currentUserData.investmentLevel || 'None'];
                if (currentUserData.totalAssets < levelInfo.minWithdraw) {
                    showMessage(`You need at least Ksh ${levelInfo.minWithdraw} to withdraw.`, true);
                    return;
                }
                DOMElements.withdrawModal.classList.remove('hidden');
            });
            DOMElements.cancelWithdrawModalBtn.addEventListener('click', () => DOMElements.withdrawModal.classList.add('hidden'));
            DOMElements.submitWithdrawalBtn.addEventListener('click', async () => {
                const levelInfo = INVESTMENT_LEVELS[currentUserData.investmentLevel || 'None'];
                const amount = parseFloat(DOMElements.withdrawAmountInput.value);
                
                if (isNaN(amount) || amount <= 0) { showMessage('Invalid amount.', true); return; }
                if (amount > currentUserData.totalAssets) { showMessage('Insufficient funds.', true); return; }
                if (amount < levelInfo.minWithdraw) { showMessage(`Minimum withdrawal is Ksh ${levelInfo.minWithdraw}.`, true); return; }

                try {
                    // Send request to the 'withdrawals' collection
                    await addDoc(collection(db, 'withdrawals'), {
                        userId: auth.currentUser.uid,
                        username: currentUserData.username,
                        amount: amount,
                        status: 'pending', // This is critical for the admin panel
                        timestamp: serverTimestamp()
                    });

                    // IMPORTANT: We NO LONGER deduct the balance here. The admin will do it upon approval.

                    showMessage('Withdrawal request sent for approval!');
                    DOMElements.withdrawModal.classList.add('hidden');
                    DOMElements.withdrawAmountInput.value = '';
                } catch (e) {
                    showMessage('Request failed. Please try again.', true);
                    console.error("Withdrawal error:", e);
                }
            });
            
            // --- Auth State Change Handler ---
            onAuthStateChanged(auth, user => { if (user) { DOMElements.authContainer.style.display = 'none'; DOMElements.appContainer.style.display = 'flex'; listenToUserData(user); } else { DOMElements.authContainer.style.display = 'flex'; DOMElements.appContainer.style.display = 'none'; if (unsubscribeUser) unsubscribeUser(); currentUserData = null; } });
        });
    </script>
</body>
</html>