<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MERIDA - Investment App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .merida-logo-text { font-weight: 900; letter-spacing: -0.05em; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .nav-item.active { color: #3b82f6; } /* blue-500 */
        .btn-disabled { background-color: #d1d5db; cursor: not-allowed; }
        .timer-warning { color: #ef4444; /* red-500 */ }
        
        /* Notification badge style */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -8px;
            min-width: 20px;
            height: 20px;
            background-color: #ef4444; /* red-500 */
            color: white;
            border-radius: 50%;
            border: 2px solid white;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
        }

        /* Blinking animation for new notifications */
        @keyframes blink {
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        .animate-blink {
            animation: blink 1.5s infinite;
        }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Auth Container -->
    <div id="auth-container" style="display: none;" class="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex flex-col items-center justify-center p-4">
        <h1 class="text-7xl font-black text-white merida-logo-text mb-6">MERIDA</h1>
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6">
            <div class="flex border-b border-gray-200">
                <button id="login-tab-btn" class="flex-1 py-3 font-semibold text-lg border-b-4 border-blue-500 text-blue-500">Login</button>
                <button id="signup-tab-btn" class="flex-1 py-3 font-semibold text-lg text-gray-500">Sign Up</button>
            </div>
            <div id="error-message" class="mt-4 text-center text-red-500 font-medium h-5"></div>
            <div class="mt-6">
                <form id="login-form">
                    <div class="mb-4"><label for="login-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-6"><label for="login-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-300 shadow-lg">Login</button>
                </form>
                <form id="signup-form" class="hidden">
                    <div class="mb-4"><label for="signup-username" class="block text-sm font-medium text-gray-700">Username</label><input type="text" id="signup-username" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-4"><label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-4"><label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="signup-password" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-6"><label for="signup-confirm-password" class="block text-sm font-medium text-gray-700">Confirm Password</label><input type="password" id="signup-confirm-password" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-300 shadow-lg">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden w-full max-w-lg mx-auto bg-slate-200 flex-col h-screen">
        <header class="bg-blue-600 text-white p-4 shadow-lg flex justify-between items-center z-10 sticky top-0">
             <div>
                <p class="text-sm opacity-80">Welcome back,</p>
                <h2 id="user-name-display" class="font-bold text-xl">User</h2>
             </div>
             <div class="flex items-center gap-5">
                <div class="text-right">
                    <p class="text-sm opacity-80">Total Assets</p>
                    <h2 id="total-assets-display" class="font-bold text-xl">Ksh 0.00</h2>
                </div>
                <div id="header-notification-bell" class="relative cursor-pointer">
                    <i class="fa-solid fa-bell text-2xl"></i>
                    <div id="header-notification-count" class="notification-badge hidden">0</div>
                </div>
             </div>
        </header>

        <main class="flex-grow p-4 overflow-y-auto pb-24">
            <!-- Home Page -->
            <div id="page-home">
                <h3 class="font-bold text-2xl text-slate-800 mb-4">Dashboard</h3>
                 <div class="grid grid-cols-2 gap-4 text-center mb-6">
                    <div id="deposit-btn" class="bg-white p-4 rounded-xl shadow-md cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-wallet text-blue-500 text-2xl"></i><p class="font-semibold text-sm mt-1 text-slate-700">Deposit</p></div>
                    <div id="withdraw-btn" class="bg-white p-4 rounded-xl shadow-md cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-money-bill-transfer text-blue-500 text-2xl"></i><p class="font-semibold text-sm mt-1 text-slate-700">Withdraw</p></div>
                </div>
                <div class="space-y-6">
                     <div>
                        <h4 class="font-bold text-xl text-slate-700 mb-3">Investment Levels</h4>
                        <div class="bg-white rounded-lg shadow-md overflow-hidden">
                             <table class="min-w-full text-sm">
                                <thead class="bg-slate-100">
                                    <tr>
                                         <th class="py-2 px-3 text-left font-semibold text-slate-600">Stake (Ksh)</th>
                                        <th class="py-2 px-3 text-center font-semibold text-slate-600">Daily Income (Ksh)</th>
                                         <th class="py-2 px-3 text-right font-semibold text-slate-600">Min. Withdraw (Ksh)</th>
                                    </tr>
                                </thead>
                                 <tbody class="divide-y divide-slate-200 text-slate-800">
                                    <tr><td class="py-3 px-3 font-medium">500</td><td class="py-3 px-3 text-center font-bold text-green-600">16</td><td class="py-3 px-3 text-right">200</td></tr>
                                    <tr><td class="py-3 px-3 font-medium">1,000</td><td class="py-3 px-3 text-center font-bold text-green-600">33</td><td class="py-3 px-3 text-right">500</td></tr>
                                     <tr><td class="py-3 px-3 font-medium">2,000</td><td class="py-3 px-3 text-center font-bold text-green-600">66</td><td class="py-3 px-3 text-right">500</td></tr>
                                    <tr><td class="py-3 px-3 font-medium">3,000</td><td class="py-3 px-3 text-center font-bold text-green-600">100</td><td class="py-3 px-3 text-right">700</td></tr>
                                     <tr><td class="py-3 px-3 font-medium">5,000</td><td class="py-3 px-3 text-center font-bold text-green-600">166</td><td class="py-3 px-3 text-right">1,000</td></tr>
                                    <tr><td class="py-3 px-3 font-medium">10,000</td><td class="py-3 px-3 text-center font-bold text-green-600">330</td><td class="py-3 px-3 text-right">1,500</td></tr>
                                   </tbody>
                            </table>
                        </div>
                    </div>
                 </div>
            </div>
            <!-- Work Page -->
            <div id="page-work" class="hidden">
                 <h3 class="font-bold text-2xl text-slate-800 mb-4">Today's Tasks</h3>
                 <div id="work-content" class="bg-white rounded-lg p-6 shadow-md min-h-[250px] flex flex-col justify-center"></div>
                 <div id="task-feedback" class="mt-4 font-semibold h-5 text-center"></div>
            </div>
            <!-- Profit Page -->
            <div id="page-profit" class="hidden">
                 <h3 class="font-bold text-2xl text-slate-800 mb-6">Profit Overview</h3>
                 <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-md text-center">
                        <p class="text-sm text-slate-600">Task Profits</p>
                        <p id="task-profits-display" class="font-bold text-2xl text-slate-800 mt-1">Ksh 0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md text-center">
                        <p class="text-sm text-slate-600">Referral Bonuses</p>
                        <p id="referral-bonuses-display" class="font-bold text-2xl text-slate-800 mt-1">Ksh 0.00</p>
                    </div>
                </div>
                <h4 class="font-bold text-xl text-slate-700 mb-3">Transaction Log</h4>
                <div id="transaction-log" class="space-y-3"></div>
            </div>
            <!-- My Page -->
            <div id="page-my" class="hidden">
                 <h3 class="font-bold text-2xl text-slate-800 mb-6">My Profile</h3>
                <div class="bg-white p-4 rounded-lg shadow-md mb-6"><h4 class="font-bold text-lg text-slate-700 mb-3">Personal Details</h4><div class="space-y-2 text-sm"><p><span class="font-semibold">Username:</span> <span id="my-username"></span></p><p><span class="font-semibold">Email:</span> <span id="my-email"></span></p><p><span class="font-semibold">User ID:</span> <span id="my-userid" class="text-xs text-slate-500"></span></p></div></div>
                <div class="bg-white p-4 rounded-lg shadow-md mb-6"><h4 class="font-bold text-lg text-slate-700 mb-3">My Referral Link</h4><div class="bg-slate-100 p-2 rounded-md flex items-center justify-between"><input id="referral-link-input" type="text" readonly value="Loading..." class="bg-transparent text-slate-600 text-xs w-full focus:outline-none"><button id="copy-referral-btn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm font-semibold">Copy</button></div></div>
                <div class="bg-white p-4 rounded-lg shadow-md mb-6"><h4 class="font-bold text-lg text-slate-700 mb-3">My Team</h4><div id="my-team-list" class="space-y-2"></div></div>
                <button id="logout-btn" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition duration-300 shadow-lg">Logout</button>
            </div>
        </main>

        <!-- Navigation Footer -->
        <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around max-w-lg mx-auto">
             <button data-page="home" class="nav-item flex-1 py-3 text-center text-slate-600 hover:bg-slate-100 transition active"><i class="fas fa-home text-xl"></i><span class="block text-xs font-medium">Home</span></button>
             <button data-page="work" class="nav-item flex-1 py-3 text-center text-slate-600 hover:bg-slate-100 transition"><i class="fas fa-briefcase text-xl"></i><span class="block text-xs font-medium">Work</span></button>
             <button data-page="profit" class="nav-item flex-1 py-3 text-center text-slate-600 hover:bg-slate-100 transition"><i class="fas fa-chart-line text-xl"></i><span class="block text-xs font-medium">Profit</span></button>
             <button data-page="my" class="nav-item flex-1 py-3 text-center text-slate-600 hover:bg-slate-100 transition"><i class="fas fa-user text-xl"></i><span class="block text-xs font-medium">My</span></button>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="deposit-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <!-- Step 1: Instructions -->
            <div id="deposit-step-1">
                <h3 class="font-bold text-xl mb-4 text-center">Deposit Instructions</h3>
                <p class="text-slate-600 mb-2 text-center">Send your investment via M-Pesa to:</p>
                <div class="bg-slate-100 p-3 rounded-lg text-center my-4">
                    <p class="text-2xl font-bold text-orange-500 tracking-wider">0745 875 920</p>
                </div>
                <p class="text-slate-500 text-sm text-center mb-4">After sending the exact investment amount, click below to confirm.</p>
                <button id="deposit-paid-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-300 shadow-lg mb-2">I Have Paid</button>
                <button id="close-deposit-modal-btn" class="text-slate-500 font-semibold w-full">Close</button>
            </div>
            <!-- Step 2: Confirmation Form -->
            <div id="deposit-step-2" class="hidden">
                <h3 class="font-bold text-xl mb-4 text-center">Confirm Your Payment</h3>
                <p class="text-slate-600 mb-4 text-sm text-center">Enter the details from the M-Pesa confirmation message you received.</p>
                <div class="space-y-4">
                    <div><label for="deposit-mpesa-name" class="block text-sm font-medium text-gray-700">M-Pesa Name</label><input type="text" id="deposit-mpesa-name" placeholder="e.g. John Doe" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div><label for="deposit-mpesa-phone" class="block text-sm font-medium text-gray-700">M-Pesa Phone Number</label><input type="text" id="deposit-mpesa-phone" placeholder="e.g. 0712345678" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div><label for="deposit-amount" class="block text-sm font-medium text-gray-700">Amount Paid (Ksh)</label><input type="number" id="deposit-amount" placeholder="e.g., 500" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                </div>
                <button id="submit-deposit-request-btn" class="mt-6 w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-300 shadow-lg mb-2">Notify Admin</button>
                <button id="deposit-back-btn" class="text-slate-500 font-semibold w-full">Back</button>
            </div>
        </div>
    </div>

    <div id="withdraw-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
             <!-- Step 1: Amount -->
             <div id="withdraw-step-1">
                <h3 class="font-bold text-xl mb-3 text-center">Request Withdrawal</h3>
                <p class="text-slate-600 mb-4 text-center">Enter amount to withdraw. Minimum depends on your level.</p>
                <input type="number" id="withdraw-amount-input" placeholder="Ksh 0.00" class="w-full text-center px-3 py-2 text-lg font-bold bg-slate-50 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <button id="confirm-withdrawal-amount-btn" class="mt-4 w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 shadow-lg transition">Confirm Amount</button>
                <button id="cancel-withdraw-modal-btn" class="mt-3 text-slate-500 font-semibold w-full">Cancel</button>
             </div>
             <!-- Step 2: M-Pesa Details -->
             <div id="withdraw-step-2" class="hidden">
                <h3 class="font-bold text-xl mb-3 text-center">Confirm Withdrawal</h3>
                <p class="text-slate-600 mb-4 text-center">Enter the M-Pesa number and name to receive <strong id="withdraw-confirm-amount">Ksh 0.00</strong>.</p>
                <div class="space-y-4">
                    <div><label for="withdraw-mpesa-phone" class="block text-sm font-medium text-gray-700">M-Pesa Phone Number</label><input type="text" id="withdraw-mpesa-phone" placeholder="e.g. 0712345678" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div><label for="withdraw-mpesa-name" class="block text-sm font-medium text-gray-700">M-Pesa Name</label><input type="text" id="withdraw-mpesa-name" placeholder="e.g. John Doe" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                </div>
                <button id="submit-withdrawal-request-btn" class="mt-6 w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-300 shadow-lg mb-2">Submit Request</button>
                <button id="withdraw-back-btn" class="text-slate-500 font-semibold w-full">Back</button>
             </div>
        </div>
    </div>
    
    <div id="notifications-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm flex flex-col max-h-[80vh]">
            <h3 class="font-bold text-xl mb-4 text-center border-b pb-3">My Inbox</h3>
            <div id="notifications-list" class="flex-grow overflow-y-auto space-y-3 pr-2">
                <!-- Notifications will be rendered here -->
            </div>
            <button id="close-notifications-modal-btn" class="mt-4 w-full bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Close</button>
        </div>
    </div>

    <div id="message-modal" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl z-50 animate-pulse"><p id="message-modal-text"></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, increment, collection, addDoc, query, where, getDocs, serverTimestamp, orderBy, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener("DOMContentLoaded", () => {
            // --- Firebase and App Configuration ---
            const firebaseConfig = {
                apiKey: "AIzaSyB8Ni8HRr5lbtvD3WDcly9xTAdAl2OKNNQ",
                authDomain: "merida-47818.firebaseapp.com",
                projectId: "merida-47818",
                storageBucket: "merida-47818.appspot.com",
                messagingSenderId: "606896191722",
                appId: "1:606896191722:web:bf309888bd1cfbb6123f93",
                measurementId: "G-SPSG3DYMY7"
            };
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // --- App State ---
            let currentUserData = null;
            let unsubscribeUser = null;
            let unsubscribeNotifications = null;
            let taskTimerInterval = null;
            let allTasks = [];

            // --- DOM Elements ---
            const DOMElements = {
                authContainer: document.getElementById('auth-container'),
                appContainer: document.getElementById('app-container'),
                loginForm: document.getElementById('login-form'),
                signupForm: document.getElementById('signup-form'),
                loginTabBtn: document.getElementById('login-tab-btn'),
                signupTabBtn: document.getElementById('signup-tab-btn'),
                errorMessage: document.getElementById('error-message'),
                userNameDisplay: document.getElementById('user-name-display'),
                totalAssetsDisplay: document.getElementById('total-assets-display'),
                logoutBtn: document.getElementById('logout-btn'),
                navItems: document.querySelectorAll('.nav-item'),
                pages: {
                    home: document.getElementById('page-home'),
                    work: document.getElementById('page-work'),
                    profit: document.getElementById('page-profit'),
                    my: document.getElementById('page-my'),
                },
                depositBtn: document.getElementById('deposit-btn'),
                withdrawBtn: document.getElementById('withdraw-btn'),
                depositModal: document.getElementById('deposit-modal'),
                depositStep1: document.getElementById('deposit-step-1'),
                depositStep2: document.getElementById('deposit-step-2'),
                depositPaidBtn: document.getElementById('deposit-paid-btn'),
                depositBackBtn: document.getElementById('deposit-back-btn'),
                closeDepositModalBtn: document.getElementById('close-deposit-modal-btn'),
                submitDepositRequestBtn: document.getElementById('submit-deposit-request-btn'),
                depositMpesaName: document.getElementById('deposit-mpesa-name'),
                depositMpesaPhone: document.getElementById('deposit-mpesa-phone'),
                depositAmount: document.getElementById('deposit-amount'),
                withdrawModal: document.getElementById('withdraw-modal'),
                withdrawStep1: document.getElementById('withdraw-step-1'),
                withdrawStep2: document.getElementById('withdraw-step-2'),
                withdrawAmountInput: document.getElementById('withdraw-amount-input'),
                confirmWithdrawalAmountBtn: document.getElementById('confirm-withdrawal-amount-btn'),
                cancelWithdrawModalBtn: document.getElementById('cancel-withdraw-modal-btn'),
                withdrawConfirmAmount: document.getElementById('withdraw-confirm-amount'),
                withdrawMpesaPhone: document.getElementById('withdraw-mpesa-phone'),
                withdrawMpesaName: document.getElementById('withdraw-mpesa-name'),
                submitWithdrawalRequestBtn: document.getElementById('submit-withdrawal-request-btn'),
                withdrawBackBtn: document.getElementById('withdraw-back-btn'),
                notificationsModal: document.getElementById('notifications-modal'),
                headerNotificationBell: document.getElementById('header-notification-bell'),
                headerNotificationCount: document.getElementById('header-notification-count'),
                notificationsList: document.getElementById('notifications-list'),
                closeNotificationsModalBtn: document.getElementById('close-notifications-modal-btn'),
                messageModal: document.getElementById('message-modal'),
                messageModalText: document.getElementById('message-modal-text'),
                taskProfitsDisplay: document.getElementById('task-profits-display'),
                referralBonusesDisplay: document.getElementById('referral-bonuses-display'),
                transactionLog: document.getElementById('transaction-log'),
                myUsername: document.getElementById('my-username'),
                myEmail: document.getElementById('my-email'),
                myUserid: document.getElementById('my-userid'),
                referralLinkInput: document.getElementById('referral-link-input'),
                copyReferralBtn: document.getElementById('copy-referral-btn'),
                myTeamList: document.getElementById('my-team-list'),
                workContent: document.getElementById('work-content'),
                taskFeedback: document.getElementById('task-feedback'),
            };
            
            // --- App Configuration ---
            const LEVEL_CONFIG = {
                'level-1': { tasksPerDay: 1, dailyReward: 16 },
                'level-2': { tasksPerDay: 2, dailyReward: 33 },
                'level-3': { tasksPerDay: 3, dailyReward: 66 },
                'level-4': { tasksPerDay: 4, dailyReward: 100 },
                'level-5': { tasksPerDay: 5, dailyReward: 166 },
                'level-6': { tasksPerDay: 6, dailyReward: 330 },
            };

            // --- Utility Functions ---
            const showMessage = (message, isError = false) => { DOMElements.messageModalText.textContent = message; DOMElements.messageModal.className = `fixed top-5 right-5 py-2 px-4 rounded-lg shadow-xl z-50 animate-pulse ${isError ? 'bg-red-500' : 'bg-green-500'} text-white`; DOMElements.messageModal.classList.remove('hidden'); setTimeout(() => { DOMElements.messageModal.classList.add('hidden'); }, 4000); };
            const formatKsh = (amount) => `Ksh ${parseFloat(amount || 0).toLocaleString('en-KE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            const formatDate = (timestamp) => timestamp ? new Date(timestamp.toDate()).toLocaleString() : 'N/A';
            const getTodayDateString = () => new Date().toISOString().split('T')[0];

            // --- Page Navigation ---
            const switchPage = (pageId) => {
                Object.values(DOMElements.pages).forEach(page => page.classList.add('hidden'));
                DOMElements.pages[pageId].classList.remove('hidden');
                DOMElements.navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
                if (pageId === 'work') loadTasks();
            };
            
            // --- Authentication ---
            const switchAuthTab = (tab) => {
                if (tab === 'login') {
                    DOMElements.loginTabBtn.classList.add('border-blue-500', 'text-blue-500');
                    DOMElements.signupTabBtn.classList.remove('border-blue-500', 'text-blue-500');
                    DOMElements.loginForm.classList.remove('hidden');
                    DOMElements.signupForm.classList.add('hidden');
                } else {
                    DOMElements.signupTabBtn.classList.add('border-blue-500', 'text-blue-500');
                    DOMElements.loginTabBtn.classList.remove('border-blue-500', 'text-blue-500');
                    DOMElements.signupForm.classList.remove('hidden');
                    DOMElements.loginForm.classList.add('hidden');
                }
                DOMElements.errorMessage.textContent = '';
            };
            
            DOMElements.loginTabBtn.addEventListener('click', () => switchAuthTab('login'));
            DOMElements.signupTabBtn.addEventListener('click', () => switchAuthTab('signup'));

            DOMElements.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = DOMElements.loginForm['login-email'].value;
                const password = DOMElements.loginForm['login-password'].value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    DOMElements.errorMessage.textContent = error.message;
                }
            });

            DOMElements.signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = DOMElements.signupForm['signup-username'].value.trim();
                const email = DOMElements.signupForm['signup-email'].value;
                const password = DOMElements.signupForm['signup-password'].value;
                const confirmPassword = DOMElements.signupForm['signup-confirm-password'].value;
                if (password !== confirmPassword) { DOMElements.errorMessage.textContent = 'Passwords do not match.'; return; }
                if (username.length < 3) { DOMElements.errorMessage.textContent = 'Username must be at least 3 characters.'; return; }
                
                try {
                    const q = query(collection(db, "users"), where("username", "==", username));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) { DOMElements.errorMessage.textContent = 'Username is already taken.'; return; }

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    const urlParams = new URLSearchParams(window.location.search);
                    const referredBy = urlParams.get('ref');
                    
                    const newUserDoc = {
                        username: username,
                        email: email,
                        createdAt: serverTimestamp(),
                        totalAssets: 0,
                        totalTaskProfits: 0,
                        totalReferralBonuses: 0,
                        investmentLevel: 'level-0',
                        referredBy: referredBy || null,
                        sponsorBonusPaid: false,
                        lastTaskDate: '',
                        dailyTasksCompleted: 0
                    };
                    await setDoc(doc(db, 'users', user.uid), newUserDoc);
                } catch (error) {
                    DOMElements.errorMessage.textContent = error.message;
                }
            });

            DOMElements.logoutBtn.addEventListener('click', () => signOut(auth));

            // --- Data Listeners & UI Updates ---
            const listenToUserData = (user) => {
                if (unsubscribeUser) unsubscribeUser();
                unsubscribeUser = onSnapshot(doc(db, 'users', user.uid), async (doc) => {
                    currentUserData = doc.data();
                    if (currentUserData) {
                        // This function now handles the daily task reset on data load
                        await initializeDailyTasks(user.uid);

                        // Update UI with latest data
                        DOMElements.userNameDisplay.textContent = currentUserData.username;
                        DOMElements.totalAssetsDisplay.textContent = formatKsh(currentUserData.totalAssets);
                        DOMElements.taskProfitsDisplay.textContent = formatKsh(currentUserData.totalTaskProfits);
                        DOMElements.referralBonusesDisplay.textContent = formatKsh(currentUserData.totalReferralBonuses);
                        DOMElements.myUsername.textContent = currentUserData.username;
                        DOMElements.myEmail.textContent = currentUserData.email;
                        DOMElements.myUserid.textContent = user.uid;
                        const referralLink = `${window.location.origin}${window.location.pathname}?ref=${user.uid}`;
                        DOMElements.referralLinkInput.value = referralLink;
                        updateTeamList(user.uid);
                        updateTransactionLog(user.uid);
                    }
                });
            };

            const listenToNotifications = (user) => {
                if (unsubscribeNotifications) unsubscribeNotifications();
                const q = query(collection(db, 'notifications'), where('userId', '==', user.uid), orderBy('timestamp', 'desc'));
                unsubscribeNotifications = onSnapshot(q, (snapshot) => {
                    const unreadCount = snapshot.docs.filter(doc => !doc.data().read).length;
                    DOMElements.headerNotificationCount.textContent = unreadCount;
                    DOMElements.headerNotificationCount.classList.toggle('hidden', unreadCount === 0);
                    DOMElements.headerNotificationBell.classList.toggle('animate-blink', unreadCount > 0);
                    
                    if (snapshot.empty) {
                        DOMElements.notificationsList.innerHTML = '<p class="text-slate-500 text-center p-4">No notifications.</p>';
                    } else {
                        DOMElements.notificationsList.innerHTML = snapshot.docs.map(doc => {
                            const data = doc.data();
                            return `<div class="p-3 rounded-lg ${data.read ? 'bg-slate-100' : 'bg-blue-100'}"><p class="font-bold">${data.title}</p><p class="text-sm text-slate-700">${data.message}</p><p class="text-xs text-slate-400 text-right">${formatDate(data.timestamp)}</p></div>`;
                        }).join('');
                    }
                });
            };
            
            const updateTeamList = async (userId) => {
                const q = query(collection(db, 'users'), where('referredBy', '==', userId));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    DOMElements.myTeamList.innerHTML = '<p class="text-slate-500 text-sm">You have not referred anyone yet.</p>';
                } else {
                    DOMElements.myTeamList.innerHTML = querySnapshot.docs.map(doc => `<div class="bg-slate-100 p-2 rounded text-sm">${doc.data().username}</div>`).join('');
                }
            };

            const updateTransactionLog = async (userId) => {
                const q = query(collection(db, `users/${userId}/transactions`), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    DOMElements.transactionLog.innerHTML = '<p class="text-slate-500 text-center p-4">No transactions yet.</p>';
                } else {
                    DOMElements.transactionLog.innerHTML = querySnapshot.docs.map(doc => {
                        const data = doc.data();
                        const isCredit = ['deposit', 'referral_bonus', 'task_reward'].includes(data.type);
                        return `<div class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center"><div class="flex items-center"><i class="fas ${isCredit ? 'fa-arrow-down text-green-500' : 'fa-arrow-up text-red-500'} mr-3"></i><div><p class="font-semibold capitalize">${(data.type || '').replace('_', ' ')}</p><p class="text-xs text-slate-400">${formatDate(data.timestamp)}</p></div></div><p class="font-bold ${isCredit ? 'text-green-600' : 'text-red-600'}">${formatKsh(data.amount)}</p></div>`;
                    }).join('');
                }
            };
            
            // --- Modals Logic ---
            // Deposit
            DOMElements.depositBtn.addEventListener('click', () => DOMElements.depositModal.classList.remove('hidden'));
            DOMElements.closeDepositModalBtn.addEventListener('click', () => DOMElements.depositModal.classList.add('hidden'));
            DOMElements.depositPaidBtn.addEventListener('click', () => { DOMElements.depositStep1.classList.add('hidden'); DOMElements.depositStep2.classList.remove('hidden'); });
            DOMElements.depositBackBtn.addEventListener('click', () => { DOMElements.depositStep2.classList.add('hidden'); DOMElements.depositStep1.classList.remove('hidden'); });
            DOMElements.submitDepositRequestBtn.addEventListener('click', async () => { /* ... existing logic ... */ });

            // Withdrawal
            DOMElements.withdrawBtn.addEventListener('click', () => {
                DOMElements.withdrawModal.classList.remove('hidden');
                DOMElements.withdrawStep1.classList.remove('hidden');
                DOMElements.withdrawStep2.classList.add('hidden');
                DOMElements.withdrawAmountInput.value = '';
            });

            DOMElements.cancelWithdrawModalBtn.addEventListener('click', () => DOMElements.withdrawModal.classList.add('hidden'));
            DOMElements.withdrawBackBtn.addEventListener('click', () => {
                DOMElements.withdrawStep2.classList.add('hidden');
                DOMElements.withdrawStep1.classList.remove('hidden');
            });

            DOMElements.confirmWithdrawalAmountBtn.addEventListener('click', () => {
                const amount = parseFloat(DOMElements.withdrawAmountInput.value);
                if (isNaN(amount) || amount <= 0) {
                    showMessage('Please enter a valid amount.', true);
                    return;
                }
                DOMElements.withdrawConfirmAmount.textContent = formatKsh(amount);
                DOMElements.withdrawStep1.classList.add('hidden');
                DOMElements.withdrawStep2.classList.remove('hidden');
            });
            
            DOMElements.submitWithdrawalRequestBtn.addEventListener('click', async () => {
                const amount = parseFloat(DOMElements.withdrawAmountInput.value);
                const phone = DOMElements.withdrawMpesaPhone.value.trim();
                const name = DOMElements.withdrawMpesaName.value.trim();

                if (isNaN(amount) || amount <= 0) { showMessage('Invalid amount.', true); return; }
                if (!phone || !name) { showMessage('Please fill in M-Pesa details.', true); return; }
                if (amount > currentUserData.totalAssets) { showMessage('Insufficient funds.', true); return; }

                try {
                    const batch = writeBatch(db);
                    const userRef = doc(db, 'users', auth.currentUser.uid);
                    const withdrawRef = doc(collection(db, 'withdrawals'));
                    
                    batch.update(userRef, { totalAssets: increment(-amount), pendingWithdrawalsAmount: increment(amount) });
                    batch.set(withdrawRef, { 
                        userId: auth.currentUser.uid, 
                        username: currentUserData.username, 
                        amount: amount, 
                        mpesaPhone: phone,
                        mpesaName: name,
                        status: 'pending', 
                        timestamp: serverTimestamp() 
                    });
                    
                    await batch.commit();
                    showMessage('Withdrawal request sent!');
                    DOMElements.withdrawModal.classList.add('hidden');
                } catch (e) {
                    showMessage('Request failed.', true);
                    console.error("Withdrawal error:", e);
                }
            });

            // Notifications
            DOMElements.headerNotificationBell.addEventListener('click', async () => {
                DOMElements.notificationsModal.classList.remove('hidden');
                const q = query(collection(db, 'notifications'), where('userId', '==', auth.currentUser.uid), where('read', '==', false));
                const snapshot = await getDocs(q);
                const batch = writeBatch(db);
                snapshot.forEach(doc => {
                    batch.update(doc.ref, { read: true });
                });
                await batch.commit();
            });
            DOMElements.closeNotificationsModalBtn.addEventListener('click', () => DOMElements.notificationsModal.classList.add('hidden'));

            // --- Task System Logic ---
            const initializeDailyTasks = async (userId) => {
                if (!currentUserData) return;
                const today = getTodayDateString();
                // If the last task date is not today, reset the daily counter.
                if (currentUserData.lastTaskDate !== today) {
                    await updateDoc(doc(db, 'users', userId), {
                        dailyTasksCompleted: 0,
                        lastTaskDate: today
                    });
                    // The onSnapshot listener will automatically refresh currentUserData
                }
            };

            const loadTasks = async () => {
                if (!currentUserData) return;

                // Daily task reset is now handled by initializeDailyTasks on login.
                // We just check the current state.
                const level = currentUserData.investmentLevel;
                if (!level || level === 'level-0' || !LEVEL_CONFIG[level]) {
                    DOMElements.workContent.innerHTML = '<p class="text-slate-500">Please activate your account by making a deposit to start completing tasks.</p>';
                    return;
                }

                const config = LEVEL_CONFIG[level];
                if (currentUserData.dailyTasksCompleted >= config.tasksPerDay) {
                    DOMElements.workContent.innerHTML = '<p class="text-green-600 font-semibold">You have completed all tasks for today. Come back tomorrow!</p>';
                    return;
                }
                
                assignAndDisplayTask();
            };

            const assignAndDisplayTask = async () => {
                DOMElements.workContent.innerHTML = '<p>Assigning a new task...</p>';
                
                // Fetch all tasks if not already loaded
                if (allTasks.length === 0) {
                    try {
                        const response = await fetch('./distributed_tasks_by_level.json');
                        allTasks = await response.json();
                    } catch (e) {
                        DOMElements.workContent.innerHTML = '<p class="text-red-500">Could not load tasks. Please try again later.</p>';
                        return;
                    }
                }

                const completedTasksSnap = await getDocs(collection(db, `users/${auth.currentUser.uid}/completedTasks`));
                const completedTaskIds = new Set(completedTasksSnap.docs.map(doc => doc.id));

                const userLevel = currentUserData.investmentLevel;
                const availableTasks = allTasks.filter(task => task.level === userLevel && !completedTaskIds.has(task.id));

                if (availableTasks.length === 0) {
                    DOMElements.workContent.innerHTML = '<p class="text-slate-500">Wow! You have completed all available tasks for your level. More will be added soon.</p>';
                    return;
                }

                const task = availableTasks[Math.floor(Math.random() * availableTasks.length)];
                renderTask(task);
            };

            const renderTask = (task) => {
                let answerHtml = '';
                if (task.options) { // Quiz or Survey
                    answerHtml = task.options.map(option => `<button class="w-full bg-slate-100 p-3 rounded-lg text-slate-700 font-semibold hover:bg-blue-200 task-option-btn" data-answer="${option}">${option}</button>`).join('');
                } else { // Math, Captcha, Logic
                    answerHtml = `<input id="task-answer-input" type="text" class="w-full text-center px-3 py-2 text-lg font-bold bg-slate-100 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Your answer here">`;
                }

                DOMElements.workContent.innerHTML = `
                    <div class="w-full">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-lg text-slate-700">${task.type.charAt(0).toUpperCase() + task.type.slice(1)} Task</h4>
                            <div id="task-timer" class="font-bold text-xl bg-slate-200 px-3 py-1 rounded-full">30:00</div>
                        </div>
                        <p class="text-slate-800 text-lg mb-6">${task.question || task.prompt}</p>
                        <div class="space-y-3">${answerHtml}</div>
                        <button id="submit-task-btn" class="mt-6 w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 shadow-lg transition">Submit Answer</button>
                    </div>
                `;
                
                startTaskTimer(task);

                if (task.options) {
                    DOMElements.workContent.querySelectorAll('.task-option-btn').forEach(btn => {
                        btn.addEventListener('click', () => handleTaskSubmission(task, btn.dataset.answer));
                    });
                } else {
                    document.getElementById('submit-task-btn').addEventListener('click', () => {
                        const answer = document.getElementById('task-answer-input').value.trim();
                        handleTaskSubmission(task, answer);
                    });
                }
            };
            
            const startTaskTimer = (task) => {
                if (taskTimerInterval) clearInterval(taskTimerInterval);
                let seconds = 1800; // 30 minutes
                const timerEl = document.getElementById('task-timer');

                taskTimerInterval = setInterval(() => {
                    seconds--;
                    const minutes = Math.floor(seconds / 60);
                    const displaySeconds = seconds % 60;
                    timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
                    
                    if (seconds <= 600) { // 10 minutes warning
                        timerEl.classList.add('timer-warning');
                    }

                    if (seconds <= 0) {
                        clearInterval(taskTimerInterval);
                        DOMElements.taskFeedback.textContent = 'Time is up! Task failed.';
                        DOMElements.taskFeedback.className = 'mt-4 font-semibold h-5 text-center text-red-500';
                        setTimeout(loadTasks, 2000);
                    }
                }, 1000);
            };

            const handleTaskSubmission = async (task, userAnswer) => {
                if (taskTimerInterval) clearInterval(taskTimerInterval);
                
                const isCorrect = userAnswer.toLowerCase() === task.answer.toString().toLowerCase();
                
                if (isCorrect) {
                    DOMElements.taskFeedback.textContent = `Correct! You've earned ${formatKsh(task.reward)}.`;
                    DOMElements.taskFeedback.className = 'mt-4 font-semibold h-5 text-center text-green-500';

                    const batch = writeBatch(db);
                    const userRef = doc(db, 'users', auth.currentUser.uid);
                    const completedTaskRef = doc(db, `users/${auth.currentUser.uid}/completedTasks`, task.id);
                    const transactionRef = doc(collection(db, `users/${auth.currentUser.uid}/transactions`));

                    batch.update(userRef, {
                        totalAssets: increment(task.reward),
                        totalTaskProfits: increment(task.reward),
                        dailyTasksCompleted: increment(1)
                    });
                    batch.set(completedTaskRef, { completedAt: serverTimestamp() });
                    batch.set(transactionRef, {
                        type: 'task_reward',
                        amount: task.reward,
                        description: `Reward for task: ${task.id}`,
                        status: 'completed',
                        timestamp: serverTimestamp()
                    });
                    await batch.commit();

                } else {
                    DOMElements.taskFeedback.textContent = 'Incorrect answer. Please try the next task.';
                    DOMElements.taskFeedback.className = 'mt-4 font-semibold h-5 text-center text-red-500';
                }
                
                setTimeout(loadTasks, 2000); // Load next task or show completion message
            };

            // --- Initial Load ---
            DOMElements.navItems.forEach(item => item.addEventListener('click', () => switchPage(item.dataset.page)));
            onAuthStateChanged(auth, user => {
                if (user) {
                    DOMElements.authContainer.style.display = 'none';
                    DOMElements.appContainer.style.display = 'flex';
                    listenToUserData(user);
                    listenToNotifications(user);
                    switchPage('home');
                } else {
                    DOMElements.authContainer.style.display = 'flex';
                    DOMElements.appContainer.style.display = 'none';
                    if (unsubscribeUser) unsubscribeUser();
                    if (unsubscribeNotifications) unsubscribeNotifications();
                    currentUserData = null;
                }
            });
            switchAuthTab('login');
        });
    </script>
</body>
</html>
