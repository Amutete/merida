<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MERIDA - Investment App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .merida-logo-text { font-weight: 900; letter-spacing: -0.05em; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .nav-item.active { color: #3b82f6; } /* blue-500 */
        .btn-disabled { background-color: #d1d5db; cursor: not-allowed; }
        
        /* Notification badge style */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -8px;
            min-width: 20px;
            height: 20px;
            background-color: #ef4444; /* red-500 */
            color: white;
            border-radius: 50%;
            border: 2px solid white;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px;
        }

        /* Blinking animation for new notifications */
        @keyframes blink {
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        .animate-blink {
            animation: blink 1.5s infinite;
        }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Auth Container -->
    <div id="auth-container" style="display: none;" class="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex flex-col items-center justify-center p-4">
        <h1 class="text-7xl font-black text-white merida-logo-text mb-6">MERIDA</h1>
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6">
            <div class="flex border-b border-gray-200">
                <button id="login-tab-btn" class="flex-1 py-3 font-semibold text-lg border-b-4 border-blue-500 text-blue-500">Login</button>
                <button id="signup-tab-btn" class="flex-1 py-3 font-semibold text-lg text-gray-500">Sign Up</button>
            </div>
            <div id="error-message" class="mt-4 text-center text-red-500 font-medium h-5"></div>
            <div class="mt-6">
                <form id="login-form">
                    <div class="mb-4"><label for="login-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="login-email" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-6"><label for="login-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-300 shadow-lg">Login</button>
                </form>
                <form id="signup-form" class="hidden">
                    <div class="mb-4"><label for="signup-username" class="block text-sm font-medium text-gray-700">Username</label><input type="text" id="signup-username" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-4"><label for="signup-email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="signup-email" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-4"><label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="signup-password" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div class="mb-6"><label for="signup-confirm-password" class="block text-sm font-medium text-gray-700">Confirm Password</label><input type="password" id="signup-confirm-password" required class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-300 shadow-lg">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden w-full max-w-lg mx-auto bg-slate-200 flex-col h-screen">
        <header class="bg-blue-600 text-white p-4 shadow-lg flex justify-between items-center z-10 sticky top-0">
             <div>
                <p class="text-sm opacity-80">Welcome back,</p>
                <h2 id="user-name-display" class="font-bold text-xl">User</h2>
             </div>
             <div class="flex items-center gap-5">
                <div class="text-right">
                    <p class="text-sm opacity-80">Total Assets</p>
                    <h2 id="total-assets-display" class="font-bold text-xl">Ksh 0.00</h2>
                </div>
                <div id="header-notification-bell" class="relative cursor-pointer">
                    <i class="fa-solid fa-bell text-2xl"></i>
                    <div id="header-notification-count" class="notification-badge hidden">0</div>
                </div>
             </div>
        </header>

        <main class="flex-grow p-4 overflow-y-auto pb-24">
            <!-- Home Page -->
            <div id="page-home">
                <h3 class="font-bold text-2xl text-slate-800 mb-4">Dashboard</h3>
                 <div class="grid grid-cols-2 gap-4 text-center mb-6">
                    <div id="deposit-btn" class="bg-white p-4 rounded-xl shadow-md cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-wallet text-blue-500 text-2xl"></i><p class="font-semibold text-sm mt-1 text-slate-700">Deposit</p></div>
                    <div id="withdraw-btn" class="bg-white p-4 rounded-xl shadow-md cursor-pointer hover:bg-slate-50 transition"><i class="fa-solid fa-money-bill-transfer text-blue-500 text-2xl"></i><p class="font-semibold text-sm mt-1 text-slate-700">Withdraw</p></div>
                </div>
                <div class="space-y-6">
                     <div>
                        <h4 class="font-bold text-xl text-slate-700 mb-3">Investment Levels</h4>
                        <div class="bg-white rounded-lg shadow-md overflow-hidden">
                             <table class="min-w-full text-sm">
                                <thead class="bg-slate-100">
                                    <tr>
                                         <th class="py-2 px-3 text-left font-semibold text-slate-600">Stake (Ksh)</th>
                                        <th class="py-2 px-3 text-center font-semibold text-slate-600">Daily Income (Ksh)</th>
                                         <th class="py-2 px-3 text-right font-semibold text-slate-600">Min. Withdraw (Ksh)</th>
                                    </tr>
                                </thead>
                                 <tbody class="divide-y divide-slate-200 text-slate-800">
                                    <tr><td class="py-3 px-3 font-medium">500</td><td class="py-3 px-3 text-center font-bold text-green-600">16</td><td class="py-3 px-3 text-right">200</td></tr>
                                    <tr><td class="py-3 px-3 font-medium">1,000</td><td class="py-3 px-3 text-center font-bold text-green-600">33</td><td class="py-3 px-3 text-right">500</td></tr>
                                     <tr><td class="py-3 px-3 font-medium">2,000</td><td class="py-3 px-3 text-center font-bold text-green-600">66</td><td class="py-3 px-3 text-right">500</td></tr>
                                    <tr><td class="py-3 px-3 font-medium">3,000</td><td class="py-3 px-3 text-center font-bold text-green-600">100</td><td class="py-3 px-3 text-right">700</td></tr>
                                     <tr><td class="py-3 px-3 font-medium">5,000</td><td class="py-3 px-3 text-center font-bold text-green-600">166</td><td class="py-3 px-3 text-right">1,000</td></tr>
                                    <tr><td class="py-3 px-3 font-medium">10,000</td><td class="py-3 px-3 text-center font-bold text-green-600">330</td><td class="py-3 px-3 text-right">1,500</td></tr>
                                   </tbody>
                            </table>
                        </div>
                    </div>
                 </div>
            </div>
            <!-- Work Page -->
            <div id="page-work" class="hidden text-center">
                 <h3 class="font-bold text-2xl text-slate-800 mb-6">Today's Task</h3>
                 <div id="work-content" class="bg-white rounded-lg p-6 shadow-md min-h-[150px] flex items-center justify-center"></div>
                 <div id="task-feedback" class="mt-4 text-green-600 font-semibold h-5"></div>
            </div>
            <!-- Profit Page -->
            <div id="page-profit" class="hidden">
                 <h3 class="font-bold text-2xl text-slate-800 mb-6">Profit Overview</h3>
                 <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-xl shadow-md text-center">
                        <p class="text-sm text-slate-600">Task Profits</p>
                        <p id="task-profits-display" class="font-bold text-2xl text-slate-800 mt-1">Ksh 0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-md text-center">
                        <p class="text-sm text-slate-600">Referral Bonuses</p>
                        <p id="referral-bonuses-display" class="font-bold text-2xl text-slate-800 mt-1">Ksh 0.00</p>
                    </div>
                </div>
                <h4 class="font-bold text-xl text-slate-700 mb-3">Transaction Log</h4>
                <div id="transaction-log" class="space-y-3"></div>
            </div>
            <!-- My Page -->
            <div id="page-my" class="hidden">
                 <h3 class="font-bold text-2xl text-slate-800 mb-6">My Profile</h3>
                <div class="bg-white p-4 rounded-lg shadow-md mb-6"><h4 class="font-bold text-lg text-slate-700 mb-3">Personal Details</h4><div class="space-y-2 text-sm"><p><span class="font-semibold">Username:</span> <span id="my-username"></span></p><p><span class="font-semibold">Email:</span> <span id="my-email"></span></p><p><span class="font-semibold">User ID:</span> <span id="my-userid" class="text-xs text-slate-500"></span></p></div></div>
                <div class="bg-white p-4 rounded-lg shadow-md mb-6"><h4 class="font-bold text-lg text-slate-700 mb-3">My Referral Link</h4><div class="bg-slate-100 p-2 rounded-md flex items-center justify-between"><input id="referral-link-input" type="text" readonly value="Loading..." class="bg-transparent text-slate-600 text-xs w-full focus:outline-none"><button id="copy-referral-btn" class="bg-blue-500 text-white px-3 py-1 rounded text-sm font-semibold">Copy</button></div></div>
                <div class="bg-white p-4 rounded-lg shadow-md mb-6"><h4 class="font-bold text-lg text-slate-700 mb-3">My Team</h4><div id="my-team-list" class="space-y-2"></div></div>
                <button id="logout-btn" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition duration-300 shadow-lg">Logout</button>
            </div>
        </main>

        <!-- Navigation Footer -->
        <footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around max-w-lg mx-auto">
             <button data-page="home" class="nav-item flex-1 py-3 text-center text-slate-600 hover:bg-slate-100 transition active"><i class="fas fa-home text-xl"></i><span class="block text-xs font-medium">Home</span></button>
             <button data-page="work" class="nav-item flex-1 py-3 text-center text-slate-600 hover:bg-slate-100 transition"><i class="fas fa-briefcase text-xl"></i><span class="block text-xs font-medium">Work</span></button>
             <button data-page="profit" class="nav-item flex-1 py-3 text-center text-slate-600 hover:bg-slate-100 transition"><i class="fas fa-chart-line text-xl"></i><span class="block text-xs font-medium">Profit</span></button>
             <button data-page="my" class="nav-item flex-1 py-3 text-center text-slate-600 hover:bg-slate-100 transition"><i class="fas fa-user text-xl"></i><span class="block text-xs font-medium">My</span></button>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="deposit-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <!-- Step 1: Instructions -->
            <div id="deposit-step-1">
                <h3 class="font-bold text-xl mb-4 text-center">Deposit Instructions</h3>
                <p class="text-slate-600 mb-2 text-center">Send your investment via M-Pesa to:</p>
                <div class="bg-slate-100 p-3 rounded-lg text-center my-4">
                    <p class="text-2xl font-bold text-orange-500 tracking-wider">0745 875 920</p>
                </div>
                <p class="text-slate-500 text-sm text-center mb-4">After sending the exact investment amount, click below to confirm.</p>
                <button id="deposit-paid-btn" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-300 shadow-lg mb-2">I Have Paid</button>
                <button id="close-deposit-modal-btn" class="text-slate-500 font-semibold w-full">Close</button>
            </div>
            <!-- Step 2: Confirmation Form -->
            <div id="deposit-step-2" class="hidden">
                <h3 class="font-bold text-xl mb-4 text-center">Confirm Your Payment</h3>
                <p class="text-slate-600 mb-4 text-sm text-center">Enter the details from the M-Pesa confirmation message you received.</p>
                <div class="space-y-4">
                    <div><label for="deposit-mpesa-name" class="block text-sm font-medium text-gray-700">M-Pesa Name</label><input type="text" id="deposit-mpesa-name" placeholder="e.g. John Doe" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div><label for="deposit-mpesa-phone" class="block text-sm font-medium text-gray-700">M-Pesa Phone Number</label><input type="text" id="deposit-mpesa-phone" placeholder="e.g. 0712345678" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                    <div><label for="deposit-amount" class="block text-sm font-medium text-gray-700">Amount Paid (Ksh)</label><input type="number" id="deposit-amount" placeholder="e.g., 500" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                </div>
                <button id="submit-deposit-request-btn" class="mt-6 w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-300 shadow-lg mb-2">Notify Admin</button>
                <button id="deposit-back-btn" class="text-slate-500 font-semibold w-full">Back</button>
            </div>
        </div>
    </div>

    <!-- NEW: Updated Withdraw Modal -->
    <div id="withdraw-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm">
            <!-- Step 1: Amount Entry -->
            <div id="withdraw-step-1">
                <h3 class="font-bold text-xl mb-3 text-center">Request Withdrawal</h3>
                <p class="text-slate-600 mb-4 text-center">Enter amount to withdraw. Minimum depends on your level.</p>
                <input type="number" id="withdraw-amount" placeholder="Ksh 0.00" class="w-full text-center px-3 py-2 text-lg font-bold bg-slate-50 border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                <button id="withdraw-next-btn" class="mt-4 w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 shadow-lg transition">Confirm Withdrawal</button>
                <button id="cancel-withdraw-modal-btn" class="mt-3 text-slate-500 font-semibold w-full text-center">Cancel</button>
            </div>
            <!-- Step 2: M-Pesa Details -->
            <div id="withdraw-step-2" class="hidden">
                <h3 class="font-bold text-xl mb-4 text-center">Confirm Withdrawal</h3>
                <div class="space-y-4">
                    <div>
                        <label for="withdraw-mpesa-phone" class="block text-sm font-medium text-gray-700">Enter the M-Pesa number</label>
                        <input type="text" id="withdraw-mpesa-phone" placeholder="e.g. 0712345678" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="withdraw-mpesa-name" class="block text-sm font-medium text-gray-700">M-Pesa name to receive <span class="font-bold">Ksh <span id="withdraw-confirm-amount">0.00</span></span>.</label>
                        <input type="text" id="withdraw-mpesa-name" placeholder="e.g. John Doe" class="mt-1 block w-full px-3 py-2 bg-slate-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <button id="submit-withdrawal-request-btn" class="mt-6 w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-300 shadow-lg mb-2">Submit Request</button>
                <button id="withdraw-back-btn" class="text-slate-500 font-semibold w-full">Back</button>
            </div>
        </div>
    </div>
    
    <div id="notifications-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-40 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm flex flex-col max-h-[80vh]">
            <h3 class="font-bold text-xl mb-4 text-center border-b pb-3">My Inbox</h3>
            <div id="notifications-list" class="flex-grow overflow-y-auto space-y-3 pr-2">
                <!-- Notifications will be rendered here -->
            </div>
            <button id="close-notifications-modal-btn" class="mt-4 w-full bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-300">Close</button>
        </div>
    </div>

    <div id="message-modal" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl z-50 animate-pulse"><p id="message-modal-text"></p></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, increment, collection, addDoc, query, where, getDocs, serverTimestamp, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener("DOMContentLoaded", () => {
            // --- Firebase and App Configuration ---
            const firebaseConfig = {
                apiKey: "AIzaSyB8Ni8HRr5lbtvD3WDcly9xTAdAl2OKNNQ",
                authDomain: "merida-47818.firebaseapp.com",
                projectId: "merida-47818",
                storageBucket: "merida-47818.appspot.com",
                messagingSenderId: "606896191722",
                appId: "1:606896191722:web:bf309888bd1cfbb6123f93",
                measurementId: "G-SPSG3DYMY7"
            };
            const INVESTMENT_LEVELS = {
                'level-1': { name: 'Level 1 (Ksh 3,00)', investment: 300, dailyIncome: 10, minWithdraw: 150 },
                'level-2': { name: 'Level 2 (Ksh 5,000)', investment: 500, dailyIncome: 166, minWithdraw: 150  },
                'level-3': { name: 'Level 3 (Ksh 10,000)', investment: 1000, dailyIncome: 33, minWithdraw: 250 },
                'level-4': { name: 'Level 3 (Ksh 25,000)', investment: 2500, dailyIncome: 83, minWithdraw: 580 },
                'level-5': { name: 'Level 5 (Ksh 50,00)', investment: 5000, dailyIncome: 166, minWithdraw: 830 },
                'level-6': { name: 'Level 6 (Ksh 100,00)', investment: 10000, dailyIncome: 333, minWithdraw: 1665 },
                'None': { name: 'No Level', investment: 0, dailyIncome: 0, minWithdraw: Infinity }
            };

            let app, auth, db, currentUserData = null, unsubscribeUser = null, unsubscribeNotifications = null, taskTimerInterval = null, taskTimerEndTime = null;
            try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error("Firebase init failed:", e); alert("Cannot connect to server."); return; }
            
            // --- DOM Element Cache ---
            const DOMElements = {
                authContainer: document.getElementById('auth-container'), appContainer: document.getElementById('app-container'), errorMessage: document.getElementById('error-message'), loginTabBtn: document.getElementById('login-tab-btn'), signupTabBtn: document.getElementById('signup-tab-btn'), loginForm: document.getElementById('login-form'), signupForm: document.getElementById('signup-form'), logoutBtn: document.getElementById('logout-btn'), navItems: document.querySelectorAll('.nav-item'), pages: { home: document.getElementById('page-home'), work: document.getElementById('page-work'), profit: document.getElementById('page-profit'), my: document.getElementById('page-my') }, userNameDisplay: document.getElementById('user-name-display'), totalAssetsDisplay: document.getElementById('total-assets-display'), myUsername: document.getElementById('my-username'), myEmail: document.getElementById('my-email'), myUserid: document.getElementById('my-userid'), referralLinkInput: document.getElementById('referral-link-input'), copyReferralBtn: document.getElementById('copy-referral-btn'), workContent: document.getElementById('work-content'), taskFeedback: document.getElementById('task-feedback'), transactionLog: document.getElementById('transaction-log'), myTeamList: document.getElementById('my-team-list'), messageModal: document.getElementById('message-modal'), messageModalText: document.getElementById('message-modal-text'),
                taskProfitsDisplay: document.getElementById('task-profits-display'), referralBonusesDisplay: document.getElementById('referral-bonuses-display'),
                // Deposit Modal
                depositBtn: document.getElementById('deposit-btn'), depositModal: document.getElementById('deposit-modal'), closeDepositModalBtn: document.getElementById('close-deposit-modal-btn'), depositStep1: document.getElementById('deposit-step-1'), depositStep2: document.getElementById('deposit-step-2'), depositPaidBtn: document.getElementById('deposit-paid-btn'), depositBackBtn: document.getElementById('deposit-back-btn'), submitDepositRequestBtn: document.getElementById('submit-deposit-request-btn'), depositAmountInput: document.getElementById('deposit-amount'), depositMpesaNameInput: document.getElementById('deposit-mpesa-name'), depositMpesaPhoneInput: document.getElementById('deposit-mpesa-phone'),
                // UPDATED: Withdraw Modal Elements
                withdrawBtn: document.getElementById('withdraw-btn'),
                withdrawModal: document.getElementById('withdraw-modal'),
                withdrawStep1: document.getElementById('withdraw-step-1'),
                withdrawStep2: document.getElementById('withdraw-step-2'),
                cancelWithdrawModalBtn: document.getElementById('cancel-withdraw-modal-btn'),
                withdrawNextBtn: document.getElementById('withdraw-next-btn'),
                withdrawBackBtn: document.getElementById('withdraw-back-btn'),
                submitWithdrawalRequestBtn: document.getElementById('submit-withdrawal-request-btn'),
                withdrawAmountInput: document.getElementById('withdraw-amount'),
                withdrawMpesaPhone: document.getElementById('withdraw-mpesa-phone'),
                withdrawMpesaName: document.getElementById('withdraw-mpesa-name'),
                withdrawConfirmAmount: document.getElementById('withdraw-confirm-amount'),
                // Notifications
                headerNotificationBell: document.getElementById('header-notification-bell'), headerNotificationCount: document.getElementById('header-notification-count'), notificationsModal: document.getElementById('notifications-modal'), notificationsList: document.getElementById('notifications-list'), closeNotificationsModalBtn: document.getElementById('close-notifications-modal-btn'),
            };

            // --- UI & Utility Functions ---
            const showMessage = (text, isError = false) => { DOMElements.messageModalText.textContent = text; DOMElements.messageModal.classList.toggle('bg-red-500', isError); DOMElements.messageModal.classList.toggle('bg-green-500', !isError); DOMElements.messageModal.classList.remove('hidden'); setTimeout(() => DOMElements.messageModal.classList.add('hidden'), 3500); };
            const switchAuthTab = (tab) => { DOMElements.errorMessage.textContent = ''; const isLogin = tab === 'login'; DOMElements.loginTabBtn.classList.toggle('border-blue-500', isLogin); DOMElements.loginTabBtn.classList.toggle('text-blue-500', isLogin); DOMElements.loginTabBtn.classList.toggle('text-gray-500', !isLogin); DOMElements.signupTabBtn.classList.toggle('border-blue-500', !isLogin); DOMElements.signupTabBtn.classList.toggle('text-blue-500', !isLogin); DOMElements.signupTabBtn.classList.toggle('text-gray-500', isLogin); DOMElements.loginForm.classList.toggle('hidden', !isLogin); DOMElements.signupForm.classList.toggle('hidden', isLogin); };
            const switchPage = (pageName) => { Object.values(DOMElements.pages).forEach(p => p.classList.add('hidden')); if(DOMElements.pages[pageName]) DOMElements.pages[pageName].classList.remove('hidden'); DOMElements.navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageName)); if (pageName === 'profit') renderProfitPage(); if (pageName === 'my') renderMyTeam(); };

            // --- Firestore & User Data Functions ---
            const createUserProfile = async (user, username) => { const userRef = doc(db, "users", user.uid); const urlParams = new URLSearchParams(window.location.search); const referrerId = urlParams.get('ref') || null; let referredByUsername = null; if(referrerId) { const referrerSnap = await getDoc(doc(db, "users", referrerId)); if(referrerSnap.exists()) { referredByUsername = referrerSnap.data().username; } } await setDoc(userRef, { uid: user.uid, username, email: user.email, createdAt: serverTimestamp(), investmentLevel: 'None', totalAssets: 0, totalTaskProfits: 0, totalReferralBonuses: 0, referredBy: referrerId, referredByUsername: referredByUsername, lastResetDate: new Date().toISOString().split('T')[0], tasksCompletedToday: 0 }); };
            const listenToUserData = (user) => { if (unsubscribeUser) unsubscribeUser(); const userRef = doc(db, "users", user.uid); unsubscribeUser = onSnapshot(userRef, (docSnap) => { if (docSnap.exists()) { currentUserData = { id: docSnap.id, ...docSnap.data() }; checkAndResetTasks(user.uid, currentUserData); updateUI(currentUserData); } }, e => console.error("Listen Error:", e)); };
            const listenToNotifications = (user) => { if (unsubscribeNotifications) unsubscribeNotifications(); const q = query(collection(db, "notifications"), where("userId", "==", user.uid), orderBy("timestamp", "desc")); unsubscribeNotifications = onSnapshot(q, (snapshot) => { let unreadCount = 0; DOMElements.notificationsList.innerHTML = ''; if (snapshot.empty) { DOMElements.notificationsList.innerHTML = '<p class="text-slate-500 text-center text-sm p-4">You have no messages.</p>'; } snapshot.docs.forEach(docSnap => { const notification = docSnap.data(); if (!notification.read) { unreadCount++; } renderNotificationItem(docSnap.id, notification); }); DOMElements.headerNotificationCount.textContent = unreadCount; const hasUnread = unreadCount > 0; DOMElements.headerNotificationCount.classList.toggle('hidden', !hasUnread); DOMElements.headerNotificationCount.classList.toggle('animate-blink', hasUnread); }); };
            const checkAndResetTasks = async (userId, userData) => { const today = new Date().toISOString().split('T')[0]; if (today !== userData.lastResetDate) { await updateDoc(doc(db, "users", userId), { tasksCompletedToday: 0, lastResetDate: today }); } };
            const updateUI = (data) => { if (!data) return; DOMElements.userNameDisplay.textContent = data.username; DOMElements.totalAssetsDisplay.textContent = `Ksh ${data.totalAssets.toFixed(2)}`; DOMElements.myUsername.textContent = data.username; DOMElements.myEmail.textContent = data.email; DOMElements.myUserid.textContent = data.uid; DOMElements.referralLinkInput.value = `${window.location.origin}${window.location.pathname}?ref=${data.uid}`; renderWorkPage(data); };
            
            // --- Page Rendering Functions ---
            const renderWorkPage = (data) => { const levelKey = data.investmentLevel || 'None'; const levelInfo = INVESTMENT_LEVELS[levelKey]; if (!levelInfo || levelKey === 'None') { DOMElements.workContent.innerHTML = `<p class="text-slate-600">Your account is not active. Please make a deposit and contact admin to activate a level.</p>`; return; } if (data.tasksCompletedToday >= 1) { DOMElements.workContent.innerHTML = `<p class="font-bold text-2xl text-green-500 my-4">Daily task completed!</p><p class="text-slate-600">Come back tomorrow for your next task.</p>`; return; } const remainingTimeMs = taskTimerEndTime ? taskTimerEndTime - Date.now() : 0; let buttonHTML; if (remainingTimeMs > 0) { const minutesLeft = Math.ceil(remainingTimeMs / (60 * 1000)); buttonHTML = `<button id="work-button" class="w-full btn-disabled text-white font-bold py-4 px-4 rounded-lg text-xl" disabled>Working... (${minutesLeft} min left)</button>`; } else if (taskTimerEndTime) { buttonHTML = `<button id="work-button" class="w-full bg-green-500 text-white font-bold py-4 px-4 rounded-lg hover:bg-green-600 shadow-lg text-xl">Complete Task</button>`; } else { buttonHTML = `<button id="work-button" class="w-full bg-blue-500 text-white font-bold py-4 px-4 rounded-lg hover:bg-blue-600 shadow-lg text-xl">Start Task</button>`; } DOMElements.workContent.innerHTML = `<p class="text-slate-600">Current Level: <span class="font-bold">${levelInfo.name}</span></p><p class="font-bold text-4xl text-blue-500 my-4">Task 1 of 1</p>${buttonHTML}`; document.getElementById('work-button')?.addEventListener('click', handleWorkButtonClick); };
            const handleWorkButtonClick = () => { if (taskTimerEndTime && (taskTimerEndTime - Date.now()) > 0) return; if (taskTimerEndTime) completeTask(); else startTaskTimer(); };
            const startTaskTimer = () => { taskTimerEndTime = Date.now() + 45 * 60 * 1000; renderWorkPage(currentUserData); taskTimerInterval = setInterval(() => { const timeLeft = taskTimerEndTime - Date.now(); if (timeLeft <= 0) { clearInterval(taskTimerInterval); taskTimerInterval = null; renderWorkPage(currentUserData); } else { const workButton = document.getElementById('work-button'); if (workButton) { const minutesLeft = Math.ceil(timeLeft / (60 * 1000)); workButton.textContent = `Working... (${minutesLeft} min left)`; } } }, 10000); };
            const completeTask = async () => { taskTimerEndTime = null; const levelInfo = INVESTMENT_LEVELS[currentUserData.investmentLevel]; const earnings = levelInfo.dailyIncome; const userRef = doc(db, "users", auth.currentUser.uid); try { const batch = writeBatch(db); batch.update(userRef, { totalAssets: increment(earnings), tasksCompletedToday: increment(1), totalTaskProfits: increment(earnings) }); const transRef = doc(collection(db, `users/${auth.currentUser.uid}/transactions`)); batch.set(transRef, { userId: auth.currentUser.uid, amount: earnings, type: 'task_profit', timestamp: serverTimestamp(), description: 'Daily task earnings' }); await batch.commit(); DOMElements.taskFeedback.textContent = `Task completed! +Ksh ${earnings.toFixed(2)} added.`; setTimeout(() => DOMElements.taskFeedback.textContent = '', 3000); } catch (e) { showMessage("Error completing task.", true); } };
            const renderProfitPage = async () => { DOMElements.taskProfitsDisplay.textContent = `Ksh ${(currentUserData.totalTaskProfits || 0).toFixed(2)}`; DOMElements.referralBonusesDisplay.textContent = `Ksh ${(currentUserData.totalReferralBonuses || 0).toFixed(2)}`; const q = query(collection(db, `users/${auth.currentUser.uid}/transactions`), orderBy("timestamp", "desc")); const querySnapshot = await getDocs(q); DOMElements.transactionLog.innerHTML = ''; if (querySnapshot.empty) { DOMElements.transactionLog.innerHTML = '<p class="text-slate-500 text-center">No transactions yet.</p>'; return; } querySnapshot.docs.forEach(docSnap => { const t = docSnap.data(); let title, amountText, amountColor; switch (t.type) { case 'task_profit': title = 'Task Profit'; amountText = `+ Ksh ${t.amount.toFixed(2)}`; amountColor = 'text-green-600'; break; case 'deposit': title = 'Deposit'; amountText = `+ Ksh ${t.amount.toFixed(2)}`; amountColor = 'text-green-600'; break; case 'withdrawal': title = 'Withdrawal'; amountText = `- Ksh ${t.amount.toFixed(2)}`; amountColor = 'text-red-600'; break; case 'referral_bonus': title = `Referral Bonus`; amountText = `+ Ksh ${t.amount.toFixed(2)}`; amountColor = 'text-blue-600'; break; default: title = 'Transaction'; amountText = `Ksh ${t.amount.toFixed(2)}`; amountColor = 'text-slate-800'; }
            DOMElements.transactionLog.innerHTML += `<div class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center"><div><p class="font-semibold text-slate-800">${title}</p><p class="text-xs text-slate-500">${t.timestamp.toDate().toLocaleString()}</p></div><p class="font-bold ${amountColor}">${amountText}</p></div>`; }); };
            const renderMyTeam = async () => { const q = query(collection(db, "users"), where("referredBy", "==", auth.currentUser.uid)); const querySnapshot = await getDocs(q); DOMElements.myTeamList.innerHTML = ''; if (querySnapshot.empty) { DOMElements.myTeamList.innerHTML = '<p class="text-slate-500 text-center">No referrals yet.</p>'; return; } querySnapshot.forEach(docSnap => { const member = docSnap.data(); const status = member.investmentLevel === 'None' ? 'Registered' : 'Active'; DOMElements.myTeamList.innerHTML += `<div class="bg-slate-100 p-2 rounded-md flex justify-between items-center text-sm"><p class="font-semibold">${member.username}</p><p class="font-bold ${status === 'Active' ? 'text-green-500' : 'text-yellow-500'}">${status}</p></div>`; }); };
            const renderNotificationItem = (id, notification) => { const item = document.createElement('div'); item.className = `p-3 rounded-lg border ${notification.read ? 'bg-slate-50' : 'bg-blue-50 border-blue-200'} cursor-pointer`; item.innerHTML = `<div class="flex justify-between items-start"><h4 class="font-bold text-slate-800">${notification.title}</h4><span class="text-xs text-slate-500">${notification.timestamp.toDate().toLocaleDateString()}</span></div><p class="text-sm text-slate-600 mt-1">${notification.message}</p>`; item.onclick = async () => { if (!notification.read) { await updateDoc(doc(db, 'notifications', id), { read: true }); } }; DOMElements.notificationsList.appendChild(item); };

            // --- Event Listeners ---
            DOMElements.loginTabBtn.addEventListener('click', () => switchAuthTab('login'));
            DOMElements.signupTabBtn.addEventListener('click', () => switchAuthTab('signup'));
            DOMElements.loginForm.addEventListener('submit', async (e) => { e.preventDefault(); DOMElements.errorMessage.textContent = ''; try { await signInWithEmailAndPassword(auth, DOMElements.loginForm['login-email'].value, DOMElements.loginForm['login-password'].value); } catch (e) { DOMElements.errorMessage.textContent = e.message.replace('Firebase: ', ''); } });
            DOMElements.signupForm.addEventListener('submit', async (e) => { e.preventDefault(); DOMElements.errorMessage.textContent = ''; const pass = DOMElements.signupForm['signup-password'].value; if (pass !== DOMElements.signupForm['signup-confirm-password'].value) { DOMElements.errorMessage.textContent = "Passwords don't match."; return; } try { const cred = await createUserWithEmailAndPassword(auth, DOMElements.signupForm['signup-email'].value, pass); await createUserProfile(cred.user, DOMElements.signupForm['signup-username'].value); } catch (e) { DOMElements.errorMessage.textContent = e.message.replace('Firebase: ', ''); } });
            DOMElements.logoutBtn.addEventListener('click', () => { signOut(auth); });
            DOMElements.copyReferralBtn.addEventListener('click', () => { DOMElements.referralLinkInput.select(); document.execCommand('copy'); showMessage('Link copied!'); });
            
            // Deposit Modal Logic
            DOMElements.depositBtn.addEventListener('click', () => { DOMElements.depositModal.classList.remove('hidden'); DOMElements.depositStep1.classList.remove('hidden'); DOMElements.depositStep2.classList.add('hidden'); });
            DOMElements.closeDepositModalBtn.addEventListener('click', () => DOMElements.depositModal.classList.add('hidden'));
            DOMElements.depositPaidBtn.addEventListener('click', () => { DOMElements.depositStep1.classList.add('hidden'); DOMElements.depositStep2.classList.remove('hidden'); });
            DOMElements.depositBackBtn.addEventListener('click', () => { DOMElements.depositStep2.classList.add('hidden'); DOMElements.depositStep1.classList.remove('hidden'); });
            DOMElements.submitDepositRequestBtn.addEventListener('click', async () => { const amount = parseFloat(DOMElements.depositAmountInput.value); const mpesaName = DOMElements.depositMpesaNameInput.value.trim(); const mpesaPhone = DOMElements.depositMpesaPhoneInput.value.trim(); if (isNaN(amount) || amount <= 0) { showMessage('Please enter a valid amount.', true); return; } if (!mpesaName || !mpesaPhone) { showMessage('Please fill out all M-Pesa details.', true); return; } try { await addDoc(collection(db, 'deposits'), { userId: auth.currentUser.uid, username: currentUserData.username, amount: amount, mpesaName: mpesaName, mpesaPhone: mpesaPhone, method: 'M-Pesa', status: 'pending', timestamp: serverTimestamp() }); showMessage('Deposit request submitted successfully!'); DOMElements.depositModal.classList.add('hidden'); DOMElements.depositAmountInput.value = ''; DOMElements.depositMpesaNameInput.value = ''; DOMElements.depositMpesaPhoneInput.value = ''; } catch (e) { showMessage('Request failed. Please try again.', true); console.error(e); } });

            // --- UPDATED: New Withdraw Modal Logic ---
            DOMElements.withdrawBtn.addEventListener('click', () => { 
                if (!currentUserData) return; 
                const levelInfo = INVESTMENT_LEVELS[currentUserData.investmentLevel || 'None']; 
                if (currentUserData.totalAssets < levelInfo.minWithdraw) { 
                    showMessage(`You need at least Ksh ${levelInfo.minWithdraw.toFixed(2)} to withdraw.`, true); 
                    return; 
                } 
                // Reset modal to step 1
                DOMElements.withdrawStep1.classList.remove('hidden');
                DOMElements.withdrawStep2.classList.add('hidden');
                DOMElements.withdrawAmountInput.value = '';
                DOMElements.withdrawMpesaName.value = '';
                DOMElements.withdrawMpesaPhone.value = '';
                DOMElements.withdrawModal.classList.remove('hidden'); 
            });

            DOMElements.cancelWithdrawModalBtn.addEventListener('click', () => DOMElements.withdrawModal.classList.add('hidden'));
            
            DOMElements.withdrawBackBtn.addEventListener('click', () => {
                DOMElements.withdrawStep2.classList.add('hidden');
                DOMElements.withdrawStep1.classList.remove('hidden');
            });

            DOMElements.withdrawNextBtn.addEventListener('click', () => {
                const levelInfo = INVESTMENT_LEVELS[currentUserData.investmentLevel || 'None'];
                const amount = parseFloat(DOMElements.withdrawAmountInput.value);

                if (isNaN(amount) || amount <= 0) { showMessage('Invalid amount.', true); return; }
                if (amount > currentUserData.totalAssets) { showMessage('Insufficient funds.', true); return; }
                if (amount < levelInfo.minWithdraw) { showMessage(`Minimum withdrawal is Ksh ${levelInfo.minWithdraw.toFixed(2)}.`, true); return; }

                // If valid, proceed to step 2
                DOMElements.withdrawConfirmAmount.textContent = amount.toFixed(2);
                DOMElements.withdrawStep1.classList.add('hidden');
                DOMElements.withdrawStep2.classList.remove('hidden');
            });

            DOMElements.submitWithdrawalRequestBtn.addEventListener('click', async () => {
                const amount = parseFloat(DOMElements.withdrawAmountInput.value);
                const mpesaName = DOMElements.withdrawMpesaName.value.trim();
                const mpesaPhone = DOMElements.withdrawMpesaPhone.value.trim();

                if (!mpesaName || !mpesaPhone) {
                    showMessage('Please provide the M-Pesa name and phone number.', true);
                    return;
                }

                try {
                    const userRef = doc(db, "users", auth.currentUser.uid);
                    const batch = writeBatch(db);
                    
                    // Decrement user's assets
                    batch.update(userRef, { 
                        totalAssets: increment(-amount) 
                    });
                    
                    // Create withdrawal request with M-Pesa details
                    const withdrawRef = doc(collection(db, 'withdrawals'));
                    batch.set(withdrawRef, {
                        userId: auth.currentUser.uid,
                        username: currentUserData.username,
                        amount: amount,
                        mpesaName: mpesaName, // New field
                        mpesaPhone: mpesaPhone, // New field
                        status: 'pending',
                        timestamp: serverTimestamp()
                    });
                    
                    await batch.commit();
                    showMessage('Withdrawal request sent!');
                    DOMElements.withdrawModal.classList.add('hidden');
                    DOMElements.withdrawAmountInput.value = '';
                } catch (e) {
                    showMessage('Request failed. Please try again.', true);
                    console.error(e);
                }
            });
            
            // Notifications Modal Logic
            const openNotifications = () => DOMElements.notificationsModal.classList.remove('hidden');
            DOMElements.headerNotificationBell.addEventListener('click', openNotifications);
            DOMElements.closeNotificationsModalBtn.addEventListener('click', () => DOMElements.notificationsModal.classList.add('hidden'));

            DOMElements.navItems.forEach(item => item.addEventListener('click', () => switchPage(item.dataset.page)));

            // --- Auth State Change Handler ---
            onAuthStateChanged(auth, user => { if (user) { DOMElements.authContainer.style.display = 'none'; DOMElements.appContainer.style.display = 'flex'; listenToUserData(user); listenToNotifications(user); switchPage('home'); } else { DOMElements.authContainer.style.display = 'flex'; DOMElements.appContainer.style.display = 'none'; if (unsubscribeUser) unsubscribeUser(); if (unsubscribeNotifications) unsubscribeNotifications(); currentUserData = null; } });
            switchAuthTab('login');
        });
    </script>
</body>
</html>
